<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BotiBot - Dashboard & Face Recognition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- Merge of dashboard and face recognition styles --- */
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --info-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        --border-radius: 20px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        overflow-y: auto;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      /* Facial Recognition Overlay Styles */
      .facial-auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: var(--primary-gradient);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(10px);
      }
      .facial-auth-container {
        text-align: center;
        color: white;
        max-width: 400px;
        padding: 40px;
      }
      .camera-frame {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 4px solid rgba(255, 255, 255, 0.3);
        margin: 0 auto 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        animation: pulse-ring 2s infinite;
        position: relative;
      }
      .camera-feed {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        display: none;
      }
      .camera-icon {
        font-size: 60px;
        color: rgba(255, 255, 255, 0.7);
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
      .auth-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 15px;
      }
      .auth-subtitle {
        font-size: 16px;
        margin-bottom: 40px;
        opacity: 0.9;
        line-height: 1.5;
      }
      .status-message {
        font-size: 14px;
        margin: 20px 0;
        min-height: 20px;
        font-weight: 500;
      }
      .verify-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid white;
        color: white;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }
      .verify-btn:hover {
        background: white;
        color: #667eea;
      }
      .verify-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      @keyframes pulse-ring {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 20px rgba(255, 255, 255, 0);
        }
      }

      .scanning {
        animation: pulse-ring 1.5s infinite;
      }

      @keyframes scanning {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Dashboard styles */
      .dashboard-header {
        background: var(--primary-gradient);
        color: white;
        padding: 40px 0;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
      }

      .dashboard-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
      }

      .dashboard-header h1,
      .dashboard-header p {
        position: relative;
        z-index: 2;
      }

      .dashboard-header h1 {
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .dashboard-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        position: relative;
        z-index: 2;
        margin-top: 20px;
      }

      .status-card {
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        margin-bottom: 30px;
        border: none;
        overflow: hidden;
        position: relative;
        background: white;
      }

      .status-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .status-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: var(--card-shadow-hover);
      }

      .status-card .card-body {
        padding: 30px 20px;
      }

      .status-card i {
        margin-bottom: 15px;
        opacity: 0.8;
      }

      .control-panel {
        background: white;
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border: none;
      }

      .control-panel:hover {
        box-shadow: var(--card-shadow-hover);
      }

      .control-panel h5 {
        color: #2d3748;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 20px;
      }

      .servo-control {
        margin: 15px 0;
      }

      .sensor-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .sensor-label {
        font-size: 0.95rem;
        color: #718096;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .timestamp {
        font-size: 0.85rem;
        color: #a0aec0;
        font-weight: 400;
        margin-top: 8px;
      }

      .card {
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: none;
        transition: var(--transition);
        overflow: hidden;
      }

      .card:hover {
        box-shadow: var(--card-shadow-hover);
      }

      .card-header {
        background: white;
        border-bottom: 2px solid #f7fafc;
        padding: 20px 25px;
        font-weight: 600;
      }

      .card-header h5 {
        margin: 0;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-body {
        padding: 25px;
      }

      .btn {
        border-radius: 15px;
        padding: 12px 30px;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .btn-primary {
        background: var(--primary-gradient);
      }

      .btn-success {
        background: var(--success-gradient);
      }

      .btn-info {
        background: var(--info-gradient);
        color: white;
      }

      /* Login/Logout button specific styles */
      #login-btn,
      #logout-btn {
        pointer-events: auto;
        cursor: pointer;
        position: relative;
        z-index: 100;
      }

      #login-btn:hover,
      #logout-btn:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        transform: translateY(-1px);
      }

      .form-range {
        height: 8px;
        border-radius: 5px;
      }

      .form-range::-webkit-slider-thumb {
        background: var(--primary-gradient);
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .form-control,
      .form-select {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 12px 15px;
        transition: var(--transition);
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .badge {
        border-radius: 10px;
        padding: 8px 16px;
      }

      .container {
        max-width: 1400px;
      }

      /* Color variants for status cards */
      .status-card.temp::before {
        background: var(--danger-gradient);
      }
      .status-card.distance::before {
        background: var(--success-gradient);
      }
      .status-card.weight::before {
        background: var(--warning-gradient);
      }
      .status-card.bpm::before {
        background: var(--secondary-gradient);
      }

      /* Print modal styles */
      .print-summary {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
      }

      .reading-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .reading-item:last-child {
        border-bottom: none;
      }

      .reading-label {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
      }

      .reading-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #28a745;
        font-family: "Courier New", monospace;
      }

      /* Responsive improvements */
      @media (max-width: 768px) {
        .dashboard-header h1 {
          font-size: 1.8rem;
        }
        .dashboard-header p {
          font-size: 1rem;
        }
        .sensor-value {
          font-size: 2rem;
        }
        .dashboard-controls {
          flex-direction: column;
          align-items: center;
        }
        .control-panel,
        .card-body {
          padding: 20px;
        }
        .chart-container {
          height: 250px;
        }
      }

      /* Hide scrollbars */
      body {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      body::-webkit-scrollbar {
        display: none;
      }

      /* Touch scrolling */
      body {
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
        cursor: grab;
      }

      body.dragging {
        cursor: grabbing;
        user-select: none;
      }

      /* Enhanced touch targets */
      .btn,
      .form-control,
      .form-select,
      .form-range {
        min-height: 48px;
        touch-action: manipulation;
      }

      /* Touch feedback */
      .btn:active,
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* Animation for loading states */
      .loading {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Notification styles */
      .alert {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--card-shadow);
      }

      /* Smooth scrolling for all elements */
      * {
        scroll-behavior: smooth;
      }

      /* Enhanced touch targets for touchscreen */
      .btn,
      .form-control,
      .form-select,
      .form-range {
        min-height: 48px;
        touch-action: manipulation;
      }

      /* Touch feedback */
      .btn:active,
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* Make sliders more touch-friendly */
      .form-range {
        height: 12px;
      }

      .form-range::-webkit-slider-thumb {
        width: 24px;
        height: 24px;
      }

      .form-range::-moz-range-thumb {
        width: 24px;
        height: 24px;
      }

      /* Custom scrollbar for fallback (hidden by default) */
      ::-webkit-scrollbar {
        width: 8px;
        background: transparent;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      /* Hide scrollbar during drag */
      body.dragging ::-webkit-scrollbar {
        display: none;
      }

      /* Notification improvements */
      .alert {
        border-radius: 15px;
        border: none;
        box-shadow: var(--card-shadow);
        backdrop-filter: blur(10px);
      }
    </style>
  </head>

  <body>
    <!-- Facial Recognition Overlay -->
    <div
      id="facial-auth-overlay"
      class="facial-auth-overlay"
      style="display: none"
    >
      <div class="facial-auth-container">
        <div class="camera-frame" id="camera-frame">
          <img id="camera-feed" class="camera-feed" alt="Camera Feed" />
          <div class="camera-icon" id="camera-icon">üîí</div>
        </div>
        <h2 class="auth-title">Secure Access Required</h2>
        <p class="auth-subtitle">
          Please verify your identity to access advanced controls
        </p>
        <div class="status-message" id="auth-status"></div>
        <button
          class="verify-btn"
          id="verify-btn"
          onclick="startFacialRecognition()"
        >
          VERIFY IDENTITY
        </button>
      </div>
    </div>
    <!-- Main Dashboard Content (Home Page - visible by default) -->
    <div id="main-dashboard" style="display: block">
      <div class="dashboard-header">
        <div class="container">
          <div class="row align-items-center mb-3">
            <div class="col-md-8">
              <h1 class="text-center text-md-start mb-0">
                <i class="fas fa-robot me-3"></i>Botibot Real-Time Monitoring
              </h1>
            </div>
            <div class="col-md-4">
              <div class="text-center text-md-end">
                <!-- Login Button (visible when not authenticated) -->
                <button
                  class="btn btn-outline-light btn-sm me-2"
                  onclick="showFacialRecognition()"
                  id="login-btn"
                  style="position: relative; z-index: 100"
                >
                  <i class="fas fa-sign-in-alt me-1"></i>Login
                </button>
                <!-- User Info and Logout (hidden until authenticated) -->
                <button
                  class="btn btn-outline-light btn-sm"
                  onclick="logout()"
                  id="logout-btn"
                  style="display: none; position: relative; z-index: 100"
                >
                  <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
                <div id="user-info" class="mb-2" style="display: none">
                  <span class="badge bg-light text-dark fs-6 me-2">
                    <i class="fas fa-user me-1"></i>
                    <span id="current-user-name">User</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <p class="text-center mb-4 fs-5">
            Real-time sensor monitoring and device control via MQTT
          </p>
          <div class="text-center mb-3">
            <span class="badge bg-info fs-6" id="connection-status">
              üîÑ Checking Connection...
            </span>
          </div>
          <div class="dashboard-controls">
            <div id="authenticated-controls" style="display: none">
              <button class="btn btn-info" onclick="printReadings()">
                <i class="fas fa-print me-2"></i>Print Readings
              </button>
              <button class="btn btn-success" onclick="showDispenseOptions()">
                <i class="fas fa-pills me-2"></i>Dispense Pill
              </button>
              <button class="btn btn-success" onclick="goToSchedule()">
                <i class="fas fa-calendar-alt me-2"></i>Schedule
              </button>
            </div>
            <!-- Public message when not authenticated -->
            <div id="public-message" style="display: block">
              <p class="text-white-50 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Login required to access dispensing controls and scheduling
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor Data Cards -->
      <div class="container mt-4">
        <!-- Status Cards Row -->
        <div class="row g-4 mb-5 justify-content-center">
          <div class="col-lg-2 col-md-4">
            <div class="card status-card temp text-center h-100">
              <div class="card-body d-flex flex-column justify-content-between">
                <div class="flex-grow-1 d-flex flex-column justify-content-center">
                  <i class="fas fa-thermometer-half fa-3x text-success mb-3"></i>
                  <div class="sensor-value text-success" id="temp-value">--</div>
                  <div class="sensor-label">Temperature (¬∞C)</div>
                  <div class="timestamp" id="temp-time">--</div>
                </div>
                <!-- Authenticated Control Button -->
                <div class="authenticated-controls mt-auto pt-2" style="display: none">
                  <button class="btn btn-sm btn-outline-success w-100" onclick="checkTemperatureAlert(event)">
                    <i class="fas fa-camera me-1"></i>Capture
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-4">
            <div class="card status-card bpm text-center h-100">
              <div class="card-body d-flex flex-column justify-content-between">
                <div class="flex-grow-1 d-flex flex-column justify-content-center">
                  <i class="fas fa-heartbeat fa-3x text-danger mb-3"></i>
                  <div class="sensor-value text-success" id="bpm-value">--</div>
                  <div class="sensor-label">Heart Rate (BPM)</div>
                  <div class="timestamp" id="bpm-time">--</div>
                </div>
                <!-- Authenticated Control Button -->
                <div class="authenticated-controls mt-auto pt-2" style="display: none">
                  <button class="btn btn-sm btn-outline-success w-100" onclick="checkHeartRateAlert(event)">
                    <i class="fas fa-camera me-1"></i>Capture
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-4">
            <div class="card status-card text-center h-100">
              <div class="card-body d-flex flex-column justify-content-between">
                <div class="flex-grow-1 d-flex flex-column justify-content-center">
                  <i class="fas fa-wine-glass-alt fa-3x text-danger mb-3"></i>
                  <div class="sensor-value text-danger" id="alcohol-value">
                    --
                  </div>
                  <div class="sensor-label">Alcohol Level</div>
                  <div class="timestamp" id="alcohol-time">--</div>
                </div>
                <div class="authenticated-controls mt-auto pt-2" style="display: none">
                  <button class="btn btn-sm btn-outline-success w-100" onclick="checkAlcoholLevel(event)">
                    <i class="fas fa-camera me-1"></i>Capture
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-4">
            <div class="card status-card distance text-center h-100">
              <div class="card-body d-flex flex-column justify-content-center">
                <i class="fas fa-ruler fa-3x text-info mb-3"></i>
                <div class="sensor-value text-info" id="distance-value">--</div>
                <div class="sensor-label">Distance (cm)</div>
                <div class="timestamp" id="distance-time">--</div>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-4">
            <div class="card status-card weight text-center h-100">
              <div class="card-body d-flex flex-column justify-content-center">
                <i class="fas fa-weight fa-3x text-warning mb-3"></i>
                <div class="sensor-value text-warning" id="weight-value">
                  --
                </div>
                <div class="sensor-label">Weight (kg)</div>
                <div class="timestamp" id="weight-time">--</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Control Panel (Authentication Required) -->
        <div id="control-panels" style="display: none">
          <div class="row g-4 mb-5">
            <div class="col-12">
              <div class="alert alert-info text-center">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>Secure Controls Area</strong> - Authentication verified
                successfully
              </div>
            </div>
            <div class="col-12">
              <div class="control-panel">
                <h5>
                  <i class="fas fa-pills text-info"></i>Pill Dispenser Control
                </h5>
                <p class="text-muted mb-3">
                  <i class="fas fa-info-circle me-2"></i>Click the button below to choose dispensing method
                </p>
                <div class="d-grid">
                  <button class="btn btn-info" onclick="showDispenseOptions()">
                    <i class="fas fa-pills me-2"></i>Dispense Pill
                  </button>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="control-panel">
                <h5>
                  <i class="fas fa-capsules text-primary"></i> Dispense Medicine
                </h5>
                <div class="servo-control">
                  <label class="form-label fw-semibold">
                    This button will activate the servo to dispense the
                    medicine.
                  </label>
                  <div class="d-grid">
                    <button class="btn btn-success" onclick="setServo()">
                      <i class="fas fa-syringe me-2"></i>Dispense Medicine
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="control-panel">
                <h5>
                  <i class="fas fa-step-forward text-success"></i>Stepper Motor
                  Control
                </h5>
                <div class="row g-3 mb-3">
                  <div class="col-6">
                    <label for="stepper-steps" class="form-label fw-semibold"
                      >Steps</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="stepper-steps"
                      placeholder="Enter steps"
                      value="1000"
                    />
                  </div>
                  <div class="col-6">
                    <label
                      for="stepper-direction"
                      class="form-label fw-semibold"
                      >Direction</label
                    >
                    <select class="form-select" id="stepper-direction">
                      <option value="CW">üîÑ Clockwise</option>
                      <option value="CCW">üîÑ Counter-clockwise</option>
                    </select>
                  </div>
                </div>
                <div class="d-grid">
                  <button class="btn btn-success" onclick="moveStepper()">
                    <i class="fas fa-play me-2"></i>Execute Movement
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-chart-line text-primary"></i>Gyroscope Data
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="gyroChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-chart-area text-success"></i>Accelerometer
                  Data
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="accelChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mb-5">
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-wine text-danger"></i>Alcohol Level Monitor
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="alcoholChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-weight-hanging text-warning"></i>Load Cell
                  Data
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="loadChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Print Modal -->
      <div
        class="modal fade"
        id="printModal"
        tabindex="-1"
        aria-labelledby="printModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="printModalLabel">
                <i class="fas fa-print text-primary me-2"></i>Current Sensor
                Readings
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="print-summary" id="printSummary">
                <!-- Readings will be populated here -->
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="window.print()"
              >
                <i class="fas fa-print me-2"></i>Print Now
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="sendToPrinter()"
              >
                <i class="fas fa-paper-plane me-2"></i>Send to Printer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dispense Options Modal -->
    <div class="modal fade" id="dispenseModal" tabindex="-1" aria-labelledby="dispenseModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dispenseModalLabel">
              <i class="fas fa-pills text-primary me-2"></i>Choose Dispensing Method
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-4">Choose your container:</p>
            <div class="row g-3">
              <div class="col-12">
                <div class="card border-primary h-100" style="cursor: pointer;" onclick="dispensePillPrecisionMode(); closeDispenseModal();">
                  <div class="card-body text-center">
                    <i class="fas fa-box fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Container 1</h5>
                    <p class="card-text text-muted">Stepper motor dispensing</p>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="card border-success h-100" style="cursor: pointer;" onclick="dispensePillQuickMode(); closeDispenseModal();">
                  <div class="card-body text-center">
                    <i class="fas fa-cube fa-3x text-success mb-3"></i>
                    <h5 class="card-title">Container 2</h5>
                    <p class="card-text text-muted">Servo motor dispensing</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Global Variables ---
      let authenticationInProgress = false;
      let monitoringInitialized = false;

      // --- Capture State Variables ---
      let temperatureCaptured = false;
      let temperatureCapturedValue = 0;
      let bpmCaptured = false;
      let bpmCapturedValue = 0;
      let alcoholCaptured = false;
      let alcoholCapturedValue = 0;

      // Helper function to check if user is authenticated
      function isUserAuthenticated() {
        const userData = sessionStorage.getItem("user_data");
        const accessToken = sessionStorage.getItem("access_token");
        return userData && accessToken;
      }

      // --- Face Recognition Logic ---
      function startFacialRecognition() {
        if (authenticationInProgress) return;
        authenticationInProgress = true;
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");

        // UI scanning state
        verifyBtn.disabled = true;
        verifyBtn.textContent = "SCANNING...";
        cameraIcon.textContent = "üì∏";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";
        cameraFrame.classList.add("scanning");
        statusMessage.textContent = "üîÑ Analyzing biometric data...";
        statusMessage.style.color = "#FFE066";

        // Use working camera preview from face_recognition.html (MJPEG stream)
        cameraFeed.src = "/video_feed";
        cameraFeed.onload = () => {
          cameraFeed.style.display = "block";
          cameraIcon.style.display = "none";
        };
        cameraFeed.onerror = () => {
          cameraFeed.style.display = "none";
          cameraIcon.style.display = "block";
          cameraIcon.textContent = "‚ùå";
        };

        // Start recognition process after 2 seconds
        setTimeout(() => authenticateWithFacialRecognition(), 2000);
      }
      function authenticateWithFacialRecognition() {
        // Capture image from video feed (same method as face_recognition.html)
        captureImageFromVideoFeed()
          .then((imageBase64) => {
            if (imageBase64) {
              console.log(
                `üì∏ Image captured from video feed, sending to port 3000...`
              );
              recognizeFaceOnPort3000(imageBase64);
            } else {
              throw new Error("Failed to capture image from video feed");
            }
          })
          .catch((error) => {
            console.error("Image capture error:", error);
            authenticationFailed("Camera capture failed: " + error.message);
          });
      }

      function captureImageFromVideoFeed() {
        return new Promise((resolve, reject) => {
          try {
            const cameraFeed = document.getElementById("camera-feed");

            if (
              !cameraFeed ||
              !cameraFeed.complete ||
              cameraFeed.naturalWidth === 0
            ) {
              reject(new Error("Camera feed not ready"));
              return;
            }

            // Create canvas to capture current frame from MJPEG stream
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            // Set canvas size to match image
            canvas.width = cameraFeed.naturalWidth || 640;
            canvas.height = cameraFeed.naturalHeight || 480;

            // Validate image dimensions
            if (canvas.width === 0 || canvas.height === 0) {
              reject(new Error("Invalid camera feed dimensions"));
              return;
            }

            // Draw current frame from MJPEG feed to canvas
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

            // Convert canvas to base64 image
            const imageDataUrl = canvas.toDataURL("image/jpeg", 0.85);
            const base64Data = imageDataUrl.split(",")[1];

            // Validate captured image
            if (!base64Data || base64Data.length < 100) {
              reject(new Error("Captured image is empty or invalid"));
              return;
            }

            console.log(
              `üì∏ Image captured from video feed (${canvas.width}x${canvas.height})`
            );
            resolve(base64Data);
          } catch (error) {
            console.error("Video feed capture error:", error);
            reject(error);
          }
        });
      }

      function recognizeFaceOnPort3000(imageBase64) {
        // Test servers in priority order - your actual server runs on port 3000
        const servers = [
          "http://localhost:3000", // Local server on port 3000
          "http://127.0.0.1:3000", // Local server on port 3000
        ];

        console.log("üîç Connecting to face recognition server on port 3000...");
        testServersAndRecognize(servers, 0, imageBase64);
      }

      function testServersAndRecognize(servers, index, imageBase64) {
        if (index >= servers.length) {
          const errorMessage =
            "No face recognition server available. Possible issues:\n" +
            "‚Ä¢ Port 3000 is blocked by browser security (unsafe port)\n" +
            "‚Ä¢ Face recognition server is not running\n" +
            "‚Ä¢ Network connectivity issues\n\n" +
            "Solutions:\n" +
            "‚Ä¢ Start your face recognition server on port 8080 or 3000\n" +
            "‚Ä¢ Use --disable-web-security flag in Chrome (not recommended)\n" +
            "‚Ä¢ Configure server to use a safe port";

          console.error("üö´ All face recognition servers failed:");
          console.error(
            "Port 3000 is typically blocked by browsers as an unsafe port."
          );
          console.error(
            "Consider running your face recognition server on port 8080 or 3000."
          );

          authenticationFailed(errorMessage);
          return;
        }

        const serverUrl = servers[index];
        console.log(`üîç Testing face recognition server: ${serverUrl}`);

        // Special handling for port 3000 warnings
        if (serverUrl.includes(":3000")) {
          console.warn(
            "‚ö†Ô∏è Attempting port 3000 - this may be blocked by browser security"
          );
        }

        // Test connection first
        fetch(`${serverUrl}/`, {
          method: "GET",
          signal: AbortSignal.timeout(3000),
        })
          .then((response) => {
            if (response.status === 200 || response.status === 404) {
              console.log(`‚úÖ Server ${serverUrl} connected`);
              tryRecognitionEndpoints(serverUrl, imageBase64);
            } else {
              console.log(
                `‚ö†Ô∏è Server ${serverUrl} returned ${response.status}, trying next...`
              );
              testServersAndRecognize(servers, index + 1, imageBase64);
            }
          })
          .catch((error) => {
            if (
              error.message.includes("ERR_UNSAFE_PORT") ||
              serverUrl.includes(":3000")
            ) {
              console.error(
                `üö´ Port 3000 blocked by browser security: ${serverUrl}`
              );
              console.error(
                "üí° Suggestion: Run your face recognition server on port 8080 or 3000"
              );
            } else {
              console.log(`‚ùå Server ${serverUrl} failed: ${error.message}`);
            }
            testServersAndRecognize(servers, index + 1, imageBase64);
          });
      }

      function tryRecognitionEndpoints(serverUrl, imageBase64) {
        // Endpoints to try - matching your actual server routes
        const endpoints = [
          "/api/face/recognize", // Your main face recognition endpoint
          "/api/auth/face-login", // Auth-based face login
          "/api/face/login", // Face login endpoint
          "/api/auth/recognize", // Auth recognize endpoint
          "/api/recognize", // Generic recognize endpoint
          "/login", // Generic login endpoint
        ];

        // Updated payload format to match your server expectations
        const payload = {
          image: imageBase64,
          timestamp: new Date().toISOString(),
          source: "web_dashboard",
        };

        tryEndpoint(serverUrl, endpoints, 0, payload);
      }

      function tryEndpoint(serverUrl, endpoints, index, payload) {
        if (index >= endpoints.length) {
          authenticationFailed(
            "All face recognition endpoints on port 3000 failed"
          );
          return;
        }

        const endpoint = endpoints[index];
        const url = `${serverUrl}${endpoint}`;

        console.log(`üîÑ Trying endpoint: ${endpoint} on ${serverUrl}`);

        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: AbortSignal.timeout(10000),
        })
          .then((response) => {
            console.log(`üì° Response from ${endpoint}: ${response.status}`);

            if (response.status === 200) {
              return response.json().then((data) => {
                console.log(
                  `‚úÖ Face recognition successful with endpoint: ${endpoint}`
                );
                console.log("‚úÖ Response data:", data);

                // Handle different response formats from your Flask server
                if (data.success && data.user) {
                  // Flask server format with 'user' field
                  const userResponse = {
                    success: true,
                    recognized_user: data.user,
                    confidence_data: { confidence: data.confidence || 0.95 },
                    access_token: data.token || data.access_token,
                  };
                  authenticationSuccessWithUser(userResponse);
                } else if (data.success && data.recognized_user) {
                  // Direct format from server
                  authenticationSuccessWithUser(data);
                } else if (
                  data.data &&
                  data.data.success &&
                  data.data.recognized_user
                ) {
                  // Wrapped format from face_recognition_client.py
                  authenticationSuccessWithUser(data.data);
                } else if (data.recognized_user) {
                  // Server response without wrapper
                  authenticationSuccessWithUser(data);
                } else if (data.authenticated) {
                  // Simple authentication response
                  const simpleResponse = {
                    success: true,
                    recognized_user: {
                      firstName: "User",
                      lastName: "",
                      email: "authenticated@user.com",
                    },
                    confidence_data: { confidence: data.confidence || 0.95 },
                  };
                  authenticationSuccessWithUser(simpleResponse);
                } else {
                  // Check for confidence data even if not recognized
                  const message =
                    data.message || data.error || "Face not recognized";
                  const confidenceData =
                    data.confidence_data || data.data?.confidence_data;
                  if (confidenceData) {
                    authenticationFailedWithConfidence(message, confidenceData);
                  } else {
                    authenticationFailed(message);
                  }
                }
              });
            } else if (response.status === 400) {
              return response
                .json()
                .then((errorData) => {
                  console.error(
                    `‚ùå Bad Request (400) from ${endpoint}:`,
                    errorData
                  );
                  console.error("Request payload was:", payload);

                  // If it's a validation error, try the next endpoint
                  const errorMessage =
                    errorData.message ||
                    errorData.error ||
                    "Bad request format";
                  console.log(
                    `‚ö†Ô∏è ${endpoint} rejected request: ${errorMessage}, trying next...`
                  );
                  tryEndpoint(serverUrl, endpoints, index + 1, payload);
                })
                .catch((parseError) => {
                  return response.text().then((errorText) => {
                    console.error(
                      `‚ùå 400 Error from ${endpoint} (couldn't parse JSON):`,
                      errorText
                    );
                    console.error("Request payload was:", payload);
                    tryEndpoint(serverUrl, endpoints, index + 1, payload);
                  });
                });
            } else if (response.status === 404) {
              console.log(`‚ö†Ô∏è Endpoint ${endpoint} not found, trying next...`);
              tryEndpoint(serverUrl, endpoints, index + 1, payload);
            } else {
              return response.text().then((errorText) => {
                console.error(
                  `‚ùå Server error ${response.status}: ${errorText}`
                );
                tryEndpoint(serverUrl, endpoints, index + 1, payload);
              });
            }
          })
          .catch((error) => {
            console.error(`‚ùå Error with endpoint ${endpoint}:`, error);
            tryEndpoint(serverUrl, endpoints, index + 1, payload);
          });
      }

      function authenticationSuccessWithUser(data) {
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");

        const user = data.recognized_user;
        const confidence = data.confidence_data?.confidence || 0.95;
        const userName =
          `${user.firstName || ""} ${user.lastName || ""}`.trim() ||
          user.email ||
          "User";

        // Update UI for success
        cameraIcon.textContent = "‚úì";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";

        cameraFrame.classList.remove("scanning");
        cameraFrame.style.borderColor = "#4CAF50";
        cameraFrame.style.background = "rgba(76, 175, 80, 0.2)";
        statusMessage.textContent = `‚úì Welcome ${userName}! (${(
          confidence * 100
        ).toFixed(1)}% confidence)`;
        statusMessage.style.color = "#4CAF50";
        verifyBtn.textContent = "ACCESS GRANTED";
        verifyBtn.style.background = "#4CAF50";
        verifyBtn.style.borderColor = "#4CAF50";

        console.log(`üéâ User recognized: ${userName} (${user.email})`);

        // Store user data for dashboard use - always store after successful recognition
        sessionStorage.setItem("user_data", JSON.stringify(user));

        // Store access token if provided, or create a session token
        if (data.access_token) {
          console.log("üîê User automatically logged in!");
          console.log(`üé´ Token: ${data.access_token.substring(0, 20)}...`);
          sessionStorage.setItem("access_token", data.access_token);
        } else {
          // Create a session token for authenticated user
          const sessionToken = `session_${user.id}_${Date.now()}`;
          sessionStorage.setItem("access_token", sessionToken);
          console.log("üîê Session token created for authenticated user");
        }

        setTimeout(() => {
          document.getElementById("facial-auth-overlay").style.display = "none";

          // Show authenticated controls and hide login button
          showAuthenticatedControls();

          // Update user info in header
          updateUserInfo(user);

          // Initialize authenticated dashboard features
          initializeDashboard();
        }, 2000);
      }
      function authenticationSuccess(confidence = 0.95) {
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");
        cameraIcon.textContent = "‚úì";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";
        cameraFrame.classList.remove("scanning");
        cameraFrame.style.borderColor = "#4CAF50";
        cameraFrame.style.background = "rgba(76, 175, 80, 0.2)";
        statusMessage.textContent = `‚úì Identity Verified! (${(
          confidence * 100
        ).toFixed(1)}% confidence)`;
        statusMessage.style.color = "#4CAF50";
        verifyBtn.textContent = "ACCESS GRANTED";
        verifyBtn.style.background = "#4CAF50";
        verifyBtn.style.borderColor = "#4CAF50";
        setTimeout(() => {
          document.getElementById("facial-auth-overlay").style.display = "none";
          document.getElementById("main-dashboard").style.display = "block";
          initializeDashboard();
        }, 1500);
      }
      function authenticationFailed(reason) {
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");
        cameraIcon.textContent = "‚ùå";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";
        cameraFrame.classList.remove("scanning");
        cameraFrame.style.borderColor = "#F44336";
        cameraFrame.style.background = "rgba(244, 67, 54, 0.2)";
        statusMessage.textContent = `‚ùå ${reason}`;
        statusMessage.style.color = "#F44336";
        verifyBtn.textContent = "TRY AGAIN";
        verifyBtn.style.background = "rgba(255,255,255,0.2)";
        verifyBtn.style.borderColor = "white";
        verifyBtn.disabled = false;
        authenticationInProgress = false;
        setTimeout(() => resetAuthenticationUI(), 3000);
      }

      function authenticationFailedWithConfidence(reason, confidenceData) {
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");

        cameraIcon.textContent = "‚ùå";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";

        cameraFrame.classList.remove("scanning");
        cameraFrame.style.borderColor = "#F44336";
        cameraFrame.style.background = "rgba(244, 67, 54, 0.2)";

        // Display detailed confidence information
        const confidence = confidenceData.confidence || 0;
        const accuracy = confidenceData.accuracy || 0;
        statusMessage.innerHTML = `‚ùå ${reason}<br>üéØ Confidence: ${(
          confidence * 100
        ).toFixed(1)}% | Accuracy: ${(accuracy * 100).toFixed(
          1
        )}%<br>üí° Try adjusting position and lighting`;
        statusMessage.style.color = "#F44336";

        verifyBtn.textContent = "TRY AGAIN";
        verifyBtn.style.background = "rgba(255,255,255,0.2)";
        verifyBtn.style.borderColor = "white";
        verifyBtn.disabled = false;

        authenticationInProgress = false;

        // Log detailed information (matching face_recognition_client.py output)
        console.log("‚ùå Face not recognized");
        console.log(`üéØ Confidence: ${confidence.toFixed(2)}`);
        console.log(`üìä Accuracy: ${accuracy.toFixed(2)}`);
        console.log("üí° Try adjusting your position and lighting");

        setTimeout(() => resetAuthenticationUI(), 5000); // Longer timeout for detailed message
      }

      function resetAuthenticationUI() {
        const verifyBtn = document.getElementById("verify-btn");
        const cameraIcon = document.getElementById("camera-icon");
        const cameraFrame = document.getElementById("camera-frame");
        const statusMessage = document.getElementById("auth-status");
        cameraIcon.textContent = "üîí";
        cameraIcon.style.display = "block";
        const cameraFeed = document.getElementById("camera-feed");
        if (cameraFeed) cameraFeed.style.display = "none";
        cameraFrame.style.borderColor = "rgba(255,255,255,0.3)";
        cameraFrame.style.background = "rgba(255,255,255,0.1)";
        statusMessage.textContent = "";
        verifyBtn.textContent = "VERIFY IDENTITY";
        verifyBtn.style.background = "rgba(255,255,255,0.2)";
        verifyBtn.style.borderColor = "white";
        verifyBtn.disabled = false;
      }
      // --- Dashboard logic ---

      // Initialize monitoring (works for both authenticated and non-authenticated users)
      function initializeMonitoring() {
        if (monitoringInitialized) {
          console.log("üîÑ Monitoring already initialized");
          return;
        }

        console.log("üöÄ Dashboard monitoring initialized");

        // Start polling for sensor data every 2 seconds
        setInterval(fetchSensorData, 2000);

        // Check MQTT status every 5 seconds
        setInterval(checkMqttStatus, 5000);

        // Initial data load
        fetchSensorData();
        checkMqttStatus();

        monitoringInitialized = true;
        console.log("‚úÖ Botibot monitoring active");
      }

      // Initialize full dashboard (for authenticated users)
      function initializeDashboard() {
        console.log("üöÄ Dashboard authenticated and initialized");
        // Dashboard is already monitoring, no need to start intervals again
        console.log("‚úÖ Botibot Dashboard fully initialized");
      }

      // Chart.js setup
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: "time",
            time: {
              displayFormats: {
                second: "HH:mm:ss",
                minute: "HH:mm",
                hour: "HH:mm",
              },
            },
            title: {
              display: true,
              text: "Time",
            },
          },
          y: {
            title: {
              display: true,
              text: "Value",
            },
          },
        },
        plugins: {
          legend: {
            display: true,
          },
        },
        animation: {
          duration: 0,
        },
      };

      // Initialize charts
      const gyroChart = new Chart(document.getElementById("gyroChart"), {
        type: "line",
        data: {
          datasets: [
            {
              label: "X",
              data: [],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Y",
              data: [],
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            },
            {
              label: "Z",
              data: [],
              borderColor: "rgb(255, 205, 86)",
              tension: 0.1,
            },
          ],
        },
        options: chartOptions,
      });

      const accelChart = new Chart(document.getElementById("accelChart"), {
        type: "line",
        data: {
          datasets: [
            {
              label: "X",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
            },
            {
              label: "Y",
              data: [],
              borderColor: "rgb(153, 102, 255)",
              tension: 0.1,
            },
            {
              label: "Z",
              data: [],
              borderColor: "rgb(255, 159, 64)",
              tension: 0.1,
            },
          ],
        },
        options: chartOptions,
      });

      const alcoholChart = new Chart(document.getElementById("alcoholChart"), {
        type: "line",
        data: {
          datasets: [
            {
              label: "Alcohol Level",
              data: [],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
          ],
        },
        options: chartOptions,
      });

      const loadChart = new Chart(document.getElementById("loadChart"), {
        type: "line",
        data: {
          datasets: [
            {
              label: "Load (g)",
              data: [],
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            },
          ],
        },
        options: chartOptions,
      });

      // Servo slider update
      // document.getElementById("servo-slider").oninput = function () {
      //   document.getElementById("servo-angle").textContent = this.value;
      // };

      // Data fetching functions
      function fetchSensorData() {
        fetch("/api/sensor-data")
          .then((response) => response.json())
          .then((data) => {
            updateDashboard(data);
          })
          .catch((error) => {
            console.error("Error fetching sensor data:", error);
          });
      }

      function checkMqttStatus() {
        fetch("/api/mqtt-status")
          .then((response) => response.json())
          .then((data) => {
            const statusElement = document.getElementById("connection-status");
            if (data.connected) {
              statusElement.innerHTML = `<i class="fas fa-wifi"></i> MQTT Connected: ${data.broker}:${data.port}`;
              statusElement.className = "badge bg-success fs-6";
            } else {
              statusElement.innerHTML = `<i class="fas fa-wifi"></i> MQTT Disconnected: ${data.broker}:${data.port}`;
              statusElement.className = "badge bg-danger fs-6";
            }
          })
          .catch((error) => {
            console.error("Error checking MQTT status:", error);
            const statusElement = document.getElementById("connection-status");
            statusElement.innerHTML =
              '<i class="fas fa-exclamation-triangle"></i> Status Unknown';
            statusElement.className = "badge bg-warning fs-6";
          });
      }

      function updateDashboard(sensorData) {
        console.log("Received sensor data:", sensorData);

        // Update status cards
        updateStatusCard("temp", sensorData.temp);
        updateStatusCard("distance", sensorData.distance);
        updateStatusCard("weight", sensorData.weight_value);
        updateStatusCard("bpm", sensorData.bpm);
        updateStatusCard("alcohol", sensorData.alcohol);

        // Update charts
        updateChart(gyroChart, sensorData.gyro, ["x", "y", "z"]);
        updateChart(accelChart, sensorData.accel, ["x", "y", "z"]);
        updateSingleChart(alcoholChart, sensorData.alcohol);
        updateSingleChart(loadChart, sensorData.weight_value);
      }

      function updateStatusCard(elementId, data) {
        if (data && data.value !== undefined) {
          const valueElement = document.getElementById(`${elementId}-value`);
          const timeElement = document.getElementById(`${elementId}-time`);

          if (valueElement && timeElement) {
            // Only restrict updates for authenticated users
            if (isUserAuthenticated()) {
              // For captured sensors, display values from sessionStorage
              if (elementId === "temp" && temperatureCaptured) {
                const capturedValue = sessionStorage.getItem("captured_temperature");
                if (capturedValue !== null) {
                  valueElement.textContent = parseFloat(capturedValue).toFixed(2);
                }
                timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                return;
              }
              if (elementId === "bpm" && bpmCaptured) {
                const capturedValue = sessionStorage.getItem("captured_bpm");
                if (capturedValue !== null) {
                  valueElement.textContent = parseFloat(capturedValue).toFixed(0);
                }
                timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                return;
              }
              if (elementId === "alcohol" && alcoholCaptured) {
                const capturedValue = sessionStorage.getItem("captured_alcohol");
                if (capturedValue !== null) {
                  valueElement.textContent = parseFloat(capturedValue).toFixed(2);
                }
                timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                return;
              }
              
              // For authenticated users with uncaptured sensors, don't update value, keep at 0
              if ((elementId === "temp" && !temperatureCaptured) ||
                  (elementId === "bpm" && !bpmCaptured) ||
                  (elementId === "alcohol" && !alcoholCaptured)) {
                // Just update timestamp, keep value at 0
                timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                return;
              }
            }
            
            // Update value and timestamp for:
            // - Non-authenticated users (all sensors show live data)
            // - Distance and weight sensors (always update for everyone)
            valueElement.textContent = data.value.toFixed(2);
            timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
          }
        }
      }

      function updateChart(chart, data, axes) {
        if (data && data.timestamp) {
          const timestamp = new Date(data.timestamp);

          axes.forEach((axis, index) => {
            if (data[axis] !== undefined) {
              chart.data.datasets[index].data.push({
                x: timestamp,
                y: data[axis],
              });

              // Keep only last 50 points
              if (chart.data.datasets[index].data.length > 50) {
                chart.data.datasets[index].data.shift();
              }
            }
          });

          chart.update("none");
        }
      }

      function updateSingleChart(chart, data) {
        if (data && data.value !== undefined && data.timestamp) {
          const timestamp = new Date(data.timestamp);

          chart.data.datasets[0].data.push({
            x: timestamp,
            y: data.value,
          });

          // Keep only last 50 points
          if (chart.data.datasets[0].data.length > 50) {
            chart.data.datasets[0].data.shift();
          }

          chart.update("none");
        }
      }

      function updateElement(elementId, value, unit = "") {
        // Check if this element is captured and should not be updated
        if (elementId === "temp-value" && temperatureCaptured) {
          return; // Don't update if temperature is captured
        }
        if (elementId === "bpm-value" && bpmCaptured) {
          return; // Don't update if BPM is captured
        }
        if (elementId === "alcohol-value" && alcoholCaptured) {
          return; // Don't update if alcohol level is captured
        }
        
        const element = document.getElementById(elementId);
        if (element) {
          if (unit && !elementId.includes("timestamp")) {
            element.textContent = `${value}${unit}`;
          } else {
            element.textContent = value;
          }
        }
      }

      // Control functions
      function setServo() {
        // Move servo to 90¬∞ to trigger dispensing
        fetch("/api/control/servo", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ angle: 90 }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showNotification("Dispensing medicine...", "success");

              // Wait 3 seconds, then return servo to 0¬∞ to close
              setTimeout(() => {
                fetch("/api/control/servo", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ angle: 0 }),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.status === "success") {
                      showNotification("Servo closed successfully.", "success");
                    } else {
                      showNotification(
                        "Error closing servo: " + data.message,
                        "danger"
                      );
                    }
                  })
                  .catch((error) => {
                    showNotification(
                      "Network error on servo close: " + error,
                      "danger"
                    );
                  });
              }, 3000);
            } else {
              showNotification("Error dispensing: " + data.message, "danger");
            }
          })
          .catch((error) => {
            showNotification("Network error: " + error, "danger");
          });
      }

      function moveStepper() {
        const steps = document.getElementById("stepper-steps").value;
        const direction = document.getElementById("stepper-direction").value;

        fetch("/api/control/stepper", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            steps: parseInt(steps),
            direction: direction,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showNotification("Stepper command sent successfully!", "success");
            } else {
              showNotification("Error: " + data.message, "danger");
            }
          })
          .catch((error) => {
            showNotification("Network error: " + error, "danger");
          });
      }

      function printReadings() {
        // Collect current sensor readings in the format expected by print.py
        const printData = {
          temp: {
            value:
              parseFloat(document.getElementById("temp-value").textContent) ||
              0,
            timestamp: new Date().toISOString(),
          },
          distance: {
            value:
              parseInt(document.getElementById("distance-value").textContent) ||
              0,
            timestamp: new Date().toISOString(),
          },
          weight_value: {
            value:
              parseFloat(document.getElementById("weight-value").textContent) ||
              0,
            timestamp: new Date().toISOString(),
          },
          bpm: {
            value:
              parseFloat(document.getElementById("bpm-value").textContent) || 0,
            timestamp: new Date().toISOString(),
          },
          alcohol: {
            value:
              parseFloat(
                document.getElementById("alcohol-value").textContent
              ) || 0,
            timestamp: new Date().toISOString(),
          },
        };

        fetch("/print-readings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(printData),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then((result) => {
            if (result.success) {
              showNotification(
                result.message || "Print command sent successfully!",
                "success"
              );
            } else {
              throw new Error(result.error || "Printing failed");
            }
          })
          .catch((error) => {
            console.error("Error printing:", error);
            showNotification("Error printing: " + error.message, "danger");
          });
      }

      // function printReadings() {
      //   const printData = {
      //     temperature:
      //       document.getElementById("temp-value")?.textContent || "N/A",
      //     distance:
      //       document.getElementById("distance-value")?.textContent || "N/A",
      //     weight: document.getElementById("weight-value")?.textContent || "N/A",
      //     bpm: document.getElementById("bpm-value")?.textContent || "N/A",
      //     alcohol:
      //       document.getElementById("alcohol-value")?.textContent || "N/A",
      //     timestamp: new Date().toISOString(),
      //   };

      //   fetch("/print-readings", {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify(printData),
      //   })
      //     .then((response) => response.json())
      //     .then((result) => {
      //       if (result.success) {
      //         showNotification(
      //           result.message || "Print command sent successfully!",
      //           "success"
      //         );
      //       } else {
      //         throw new Error(result.error || "Printing failed");
      //       }
      //     })
      //     .catch((error) => {
      //       console.error("Error printing:", error);
      //       showNotification("Error printing: " + error.message, "danger");
      //     });
      // }

      function showDispenseOptions() {
        const dispenseModal = new bootstrap.Modal(document.getElementById('dispenseModal'));
        dispenseModal.show();
      }

      function closeDispenseModal() {
        const dispenseModal = bootstrap.Modal.getInstance(document.getElementById('dispenseModal'));
        if (dispenseModal) {
          dispenseModal.hide();
        }
      }

      function dispensePill() {
        // This function is now replaced by showDispenseOptions()
        showDispenseOptions();
      }

      function dispensePillPrecisionMode() {
        const steps = document.getElementById("stepper-steps").value;
        const direction = document.getElementById("stepper-direction").value;

        showNotification("üîÑ Dispensing pill with precision mode...", "info");

        fetch("/api/control/stepper", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            steps: parseInt(steps),
            direction: direction,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showNotification("‚úÖ Pill dispensed successfully with precision mode!", "success");
            } else {
              showNotification(
                "‚ùå Error dispensing pill: " + data.message,
                "danger"
              );
            }
          })
          .catch((error) => {
            showNotification("üîå Network error: " + error, "danger");
          });
      }

      function dispensePillQuickMode() {
        showNotification("üîÑ Dispensing pill with quick mode...", "info");
        
        // Move servo to 90¬∞ to trigger dispensing
        fetch("/api/control/servo", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ angle: 90 }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showNotification("üè• Dispensing medicine in quick mode...", "success");

              // Wait 3 seconds, then return servo to 0¬∞ to close
              setTimeout(() => {
                fetch("/api/control/servo", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ angle: 0 }),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.status === "success") {
                      showNotification("‚úÖ Pill dispensed successfully with quick mode!", "success");
                    } else {
                      showNotification(
                        "‚ö†Ô∏è Pill dispensed but error closing mechanism: " + data.message,
                        "warning"
                      );
                    }
                  })
                  .catch((error) => {
                    showNotification(
                      "‚ö†Ô∏è Pill dispensed but network error on close: " + error,
                      "warning"
                    );
                  });
              }, 3000);
            } else {
              showNotification(
                "‚ùå Error dispensing pill with quick mode: " + data.message,
                "danger"
              );
            }
          })
          .catch((error) => {
            showNotification("üîå Network error: " + error, "danger");
          });
      }

      // Status Card Control Functions
      function checkTemperatureAlert(event) {
        const tempElement = document.getElementById("temp-value");
        
        console.log("üå°Ô∏è Temperature capture clicked - Current state:", temperatureCaptured);
        
        if (!temperatureCaptured) {
          // Capture and save current sensor value to sessionStorage
          console.log("üîÑ Fetching current temperature sensor data...");
          fetch("/api/sensor-data")
            .then((response) => response.json())
            .then((data) => {
              console.log("üìä Received sensor data:", data);
              temperatureCapturedValue = data.temp ? data.temp.value : 0;
              temperatureCaptured = true;
              
              console.log("üíæ Saving to sessionStorage - Value:", temperatureCapturedValue);
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_temperature", temperatureCapturedValue.toString());
              sessionStorage.setItem("temperature_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved:", {
                captured_temperature: sessionStorage.getItem("captured_temperature"),
                temperature_captured: sessionStorage.getItem("temperature_captured")
              });
              
              // Display the captured value
              tempElement.textContent = temperatureCapturedValue.toFixed(2);
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkTemperatureAlert(event)"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Temperature Captured: ${temperatureCapturedValue.toFixed(2)}¬∞C - Value locked`, "info");
            })
            .catch((error) => {
              console.error("‚ùå Error fetching sensor data:", error);
              temperatureCapturedValue = 0;
              temperatureCaptured = true;
              
              console.log("üíæ Saving fallback value to sessionStorage");
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_temperature", "0");
              sessionStorage.setItem("temperature_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved (fallback):", {
                captured_temperature: sessionStorage.getItem("captured_temperature"),
                temperature_captured: sessionStorage.getItem("temperature_captured")
              });
              
              tempElement.textContent = "0.00";
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkTemperatureAlert(event)"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Temperature Captured: 0.00¬∞C - Value locked`, "info");
            });
        } else {
          // Release capture and clear sessionStorage
          console.log("üîì Releasing temperature capture and clearing sessionStorage");
          temperatureCaptured = false;
          
          // Clear from sessionStorage
          sessionStorage.removeItem("captured_temperature");
          sessionStorage.removeItem("temperature_captured");
          
          console.log("üóëÔ∏è SessionStorage cleared:", {
            captured_temperature: sessionStorage.getItem("captured_temperature"),
            temperature_captured: sessionStorage.getItem("temperature_captured")
          });
          
          tempElement.textContent = "0.00";
          
          // Update button appearance - find button by onclick attribute
          const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkTemperatureAlert(event)"]');
          if (button) {
            button.innerHTML = '<i class="fas fa-camera me-1"></i>Capture';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-outline-success');
          }
          
          showNotification(`üîì Temperature Released - Reset to 0`, "success");
        }
      }

      function checkHeartRateAlert(event) {
        const bpmElement = document.getElementById("bpm-value");
        
        console.log("üíì BPM capture clicked - Current state:", bpmCaptured);
        
        if (!bpmCaptured) {
          // Capture and save current sensor value to sessionStorage
          console.log("üîÑ Fetching current BPM sensor data...");
          fetch("/api/sensor-data")
            .then((response) => response.json())
            .then((data) => {
              console.log("üìä Received sensor data:", data);
              bpmCapturedValue = data.bpm ? data.bpm.value : 0;
              bpmCaptured = true;
              
              console.log("üíæ Saving to sessionStorage - Value:", bpmCapturedValue);
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_bpm", bpmCapturedValue.toString());
              sessionStorage.setItem("bpm_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved:", {
                captured_bpm: sessionStorage.getItem("captured_bpm"),
                bpm_captured: sessionStorage.getItem("bpm_captured")
              });
              
              // Display the captured value
              bpmElement.textContent = bpmCapturedValue.toFixed(0);
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkHeartRateAlert(event)"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Heart Rate Captured: ${bpmCapturedValue.toFixed(0)} BPM - Value locked`, "info");
            })
            .catch((error) => {
              console.error("‚ùå Error fetching sensor data:", error);
              bpmCapturedValue = 0;
              bpmCaptured = true;
              
              console.log("üíæ Saving fallback value to sessionStorage");
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_bpm", "0");
              sessionStorage.setItem("bpm_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved (fallback):", {
                captured_bpm: sessionStorage.getItem("captured_bpm"),
                bpm_captured: sessionStorage.getItem("bpm_captured")
              });
              
              bpmElement.textContent = "0";
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkHeartRateAlert()"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Heart Rate Captured: 0 BPM - Value locked`, "info");
            });
        } else {
          // Release capture and clear sessionStorage
          console.log("üîì Releasing BPM capture and clearing sessionStorage");
          bpmCaptured = false;
          
          // Clear from sessionStorage
          sessionStorage.removeItem("captured_bpm");
          sessionStorage.removeItem("bpm_captured");
          
          console.log("üóëÔ∏è SessionStorage cleared:", {
            captured_bpm: sessionStorage.getItem("captured_bpm"),
            bpm_captured: sessionStorage.getItem("bpm_captured")
          });
          
          bpmElement.textContent = "0";
          
          const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkHeartRateAlert(event)"]');
          if (button) {
            button.innerHTML = '<i class="fas fa-camera me-1"></i>Capture';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-outline-success');
          }
          
          showNotification(`üîì Heart Rate Released - Reset to 0`, "success");
        }
      }

      function checkAlcoholLevel(event) {
        const alcoholElement = document.getElementById("alcohol-value");
        
        console.log("üç∑ Alcohol capture clicked - Current state:", alcoholCaptured);
        
        if (!alcoholCaptured) {
          // Capture and save current sensor value to sessionStorage
          console.log("üîÑ Fetching current alcohol sensor data...");
          fetch("/api/sensor-data")
            .then((response) => response.json())
            .then((data) => {
              console.log("üìä Received sensor data:", data);
              alcoholCapturedValue = data.alcohol ? data.alcohol.value : 0;
              alcoholCaptured = true;
              
              console.log("üíæ Saving to sessionStorage - Value:", alcoholCapturedValue);
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_alcohol", alcoholCapturedValue.toString());
              sessionStorage.setItem("alcohol_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved:", {
                captured_alcohol: sessionStorage.getItem("captured_alcohol"),
                alcohol_captured: sessionStorage.getItem("alcohol_captured")
              });
              
              // Display the captured value
              alcoholElement.textContent = alcoholCapturedValue.toFixed(2);
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkAlcoholLevel()"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Alcohol Level Captured: ${alcoholCapturedValue.toFixed(2)} - Value locked`, "info");
            })
            .catch((error) => {
              console.error("‚ùå Error fetching sensor data:", error);
              alcoholCapturedValue = 0;
              alcoholCaptured = true;
              
              console.log("üíæ Saving fallback value to sessionStorage");
              
              // Save to sessionStorage
              sessionStorage.setItem("captured_alcohol", "0");
              sessionStorage.setItem("alcohol_captured", "true");
              
              // Verify storage
              console.log("‚úÖ SessionStorage saved (fallback):", {
                captured_alcohol: sessionStorage.getItem("captured_alcohol"),
                alcohol_captured: sessionStorage.getItem("alcohol_captured")
              });
              
              alcoholElement.textContent = "0";
              
              // Update button appearance - find button by onclick attribute
              const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkAlcoholLevel(event)"]');
              if (button) {
                button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-outline-danger');
              }
              
              showNotification(`üì∏ Alcohol Level Captured: 0 - Value locked`, "info");
            });
        } else {
          // Release capture and clear sessionStorage
          console.log("üîì Releasing alcohol capture and clearing sessionStorage");
          alcoholCaptured = false;
          
          // Clear from sessionStorage
          sessionStorage.removeItem("captured_alcohol");
          sessionStorage.removeItem("alcohol_captured");
          
          console.log("üóëÔ∏è SessionStorage cleared:", {
            captured_alcohol: sessionStorage.getItem("captured_alcohol"),
            alcohol_captured: sessionStorage.getItem("alcohol_captured")
          });
          
          alcoholElement.textContent = "0";
          
          // Update button appearance - find button by onclick attribute
          const button = event ? event.target.closest('button') : document.querySelector('button[onclick="checkAlcoholLevel(event)"]');
          if (button) {
            button.innerHTML = '<i class="fas fa-camera me-1"></i>Capture';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-outline-success');
          }
          
          showNotification(`üîì Alcohol Level Released - Reset to 0`, "success");
        }
      }

      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText =
          "top: 20px; right: 20px; z-index: 10000; min-width: 300px;";
        notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${
                      type === "success"
                        ? "check-circle"
                        : "exclamation-triangle"
                    } me-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }

      // Touch/Drag Scrolling Implementation
      function initializeTouchScrolling() {
        let isScrolling = false;
        let startY = 0;
        let startX = 0;
        let scrollTop = 0;
        let scrollLeft = 0;
        let isMouseDown = false;

        const body = document.body;
        const html = document.documentElement;

        // Mouse Events
        body.addEventListener("mousedown", function (e) {
          if (
            e.target.matches(
              "button, input, select, textarea, a, .btn, .form-control, .form-select, .form-range"
            )
          ) {
            return;
          }

          isMouseDown = true;
          isScrolling = true;
          startY = e.clientY;
          startX = e.clientX;
          scrollTop = window.pageYOffset || html.scrollTop;
          scrollLeft = window.pageXOffset || html.scrollLeft;

          body.classList.add("dragging");
          e.preventDefault();
        });

        body.addEventListener("mousemove", function (e) {
          if (!isScrolling || !isMouseDown) return;

          e.preventDefault();

          const deltaY = startY - e.clientY;
          const deltaX = startX - e.clientX;

          window.scrollTo(scrollLeft + deltaX * 0.8, scrollTop + deltaY * 0.8);
        });

        body.addEventListener("mouseup", function (e) {
          isMouseDown = false;
          isScrolling = false;
          body.classList.remove("dragging");
        });

        body.addEventListener("mouseleave", function (e) {
          isMouseDown = false;
          isScrolling = false;
          body.classList.remove("dragging");
        });

        // Touch Events
        body.addEventListener(
          "touchstart",
          function (e) {
            if (
              e.target.matches(
                "button, input, select, textarea, a, .btn, .form-control, .form-select, .form-range"
              )
            ) {
              return;
            }

            if (e.touches.length === 1) {
              isScrolling = true;
              const touch = e.touches[0];
              startY = touch.clientY;
              startX = touch.clientX;
              scrollTop = window.pageYOffset || html.scrollTop;
              scrollLeft = window.pageXOffset || html.scrollLeft;

              body.classList.add("dragging");
            }
          },
          { passive: true }
        );

        body.addEventListener(
          "touchmove",
          function (e) {
            if (!isScrolling || e.touches.length !== 1) return;

            const touch = e.touches[0];
            const deltaY = startY - touch.clientY;
            const deltaX = startX - touch.clientX;

            window.scrollTo(
              scrollLeft + deltaX * 0.8,
              scrollTop + deltaY * 0.8
            );
            e.preventDefault();
          },
          { passive: false }
        );

        body.addEventListener(
          "touchend",
          function (e) {
            isScrolling = false;
            body.classList.remove("dragging");
          },
          { passive: true }
        );

        console.log("üñ±Ô∏è Touch scrolling initialized");
      }

      // Check for existing authentication on page load
      function checkExistingAuthentication() {
        const userData = sessionStorage.getItem("user_data");
        const accessToken = sessionStorage.getItem("access_token");

        if (userData && accessToken) {
          try {
            const user = JSON.parse(userData);
            console.log("üîê Found existing authentication for:", user.email);

            // Show authenticated controls
            showAuthenticatedControls();

            // Update user info in header
            updateUserInfo(user);

            console.log("‚úÖ Auto-login successful");
            return true;
          } catch (error) {
            console.error("Error parsing stored user data:", error);
            // Clear invalid data
            sessionStorage.removeItem("user_data");
            sessionStorage.removeItem("access_token");
          }
        }

        console.log("üîç No existing authentication found, showing home page");
        // Ensure we're in the default state
        hideAuthenticatedControls();
        return false;
      }

      // Update user info display in header
      function updateUserInfo(user) {
        const userName =
          `${user.firstName || ""} ${user.lastName || ""}`.trim() ||
          user.email ||
          "User";
        const userNameElement = document.getElementById("current-user-name");
        const userInfoElement = document.getElementById("user-info");
        const logoutBtn = document.getElementById("logout-btn");

        if (userNameElement) {
          userNameElement.textContent = userName;
        }
        if (userInfoElement) {
          userInfoElement.style.display = "block";
        }
        if (logoutBtn) {
          logoutBtn.style.display = "inline-block";
        }
      }

      // Show facial recognition overlay
      function showFacialRecognition() {
        console.log("üîÑ Login button clicked - showing facial recognition");
        document.getElementById("facial-auth-overlay").style.display = "flex";
        resetAuthenticationUI();
      }

      // Show authenticated controls and hide login button
      function showAuthenticatedControls() {
        // Hide login button and public message
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("public-message").style.display = "none";

        // Show authenticated controls and control panels
        document.getElementById("authenticated-controls").style.display =
          "block";
        document.getElementById("control-panels").style.display = "block";

        // Show authenticated controls in status cards
        const statusCardControls = document.querySelectorAll(".authenticated-controls");
        statusCardControls.forEach(control => {
          control.style.display = "block";
        });

        // Restore captured sensor values from sessionStorage or set to 0
        restoreCapturedValues();

        console.log("‚úÖ Authenticated controls now visible - sensor values restored from sessionStorage");
      }

      // Restore captured values from sessionStorage
      function restoreCapturedValues() {
        console.log("üîÑ Restoring captured values from sessionStorage...");
        
        // Log all sessionStorage contents for debugging
        console.log("üíæ Current sessionStorage contents:", {
          captured_temperature: sessionStorage.getItem("captured_temperature"),
          temperature_captured: sessionStorage.getItem("temperature_captured"),
          captured_bpm: sessionStorage.getItem("captured_bpm"),
          bpm_captured: sessionStorage.getItem("bpm_captured"),
          captured_alcohol: sessionStorage.getItem("captured_alcohol"),
          alcohol_captured: sessionStorage.getItem("alcohol_captured")
        });
        
        // Restore temperature
        const tempCaptured = sessionStorage.getItem("temperature_captured") === "true";
        const tempValue = sessionStorage.getItem("captured_temperature");
        console.log("üå°Ô∏è Temperature restore - Captured:", tempCaptured, "Value:", tempValue);
        
        if (tempCaptured && tempValue !== null) {
          temperatureCaptured = true;
          temperatureCapturedValue = parseFloat(tempValue);
          document.getElementById("temp-value").textContent = parseFloat(tempValue).toFixed(2);
          
          // Update button to show release state
          const tempButtons = document.querySelectorAll('button[onclick="checkTemperatureAlert(event)"]');
          tempButtons.forEach(button => {
            button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-outline-danger');
          });
          console.log("‚úÖ Temperature restored:", parseFloat(tempValue).toFixed(2));
        } else {
          temperatureCaptured = false;
          document.getElementById("temp-value").textContent = "0.00";
          console.log("‚û°Ô∏è Temperature not captured, set to 0.00");
        }

        // Restore BPM
        const bpmCapturedState = sessionStorage.getItem("bpm_captured") === "true";
        const bpmValue = sessionStorage.getItem("captured_bpm");
        console.log("üíì BPM restore - Captured:", bpmCapturedState, "Value:", bpmValue);
        
        if (bpmCapturedState && bpmValue !== null) {
          bpmCaptured = true;
          bpmCapturedValue = parseFloat(bpmValue);
          document.getElementById("bpm-value").textContent = parseFloat(bpmValue).toFixed(0);
          
          // Update button to show release state
          const bpmButtons = document.querySelectorAll('button[onclick="checkHeartRateAlert(event)"]');
          bpmButtons.forEach(button => {
            button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-outline-danger');
          });
          console.log("‚úÖ BPM restored:", parseFloat(bpmValue).toFixed(0));
        } else {
          bpmCaptured = false;
          document.getElementById("bpm-value").textContent = "0";
          console.log("‚û°Ô∏è BPM not captured, set to 0");
        }

        // Restore alcohol
        const alcoholCapturedState = sessionStorage.getItem("alcohol_captured") === "true";
        const alcoholValue = sessionStorage.getItem("captured_alcohol");
        console.log("üç∑ Alcohol restore - Captured:", alcoholCapturedState, "Value:", alcoholValue);
        
        if (alcoholCapturedState && alcoholValue !== null) {
          alcoholCaptured = true;
          alcoholCapturedValue = parseFloat(alcoholValue);
          document.getElementById("alcohol-value").textContent = parseFloat(alcoholValue).toFixed(2);
          
          // Update button to show release state
          const alcoholButtons = document.querySelectorAll('button[onclick="checkAlcoholLevel(event)"]');
          alcoholButtons.forEach(button => {
            button.innerHTML = '<i class="fas fa-lock me-1"></i>Release';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-outline-danger');
          });
          console.log("‚úÖ Alcohol restored:", parseFloat(alcoholValue).toFixed(2));
        } else {
          alcoholCaptured = false;
          document.getElementById("alcohol-value").textContent = "0";
          console.log("‚û°Ô∏è Alcohol not captured, set to 0");
        }
        
        console.log("üèÅ Restore complete - Final states:", {
          temperatureCaptured, 
          bpmCaptured, 
          alcoholCaptured
        });
      }

      // Hide authenticated controls and show login button
      function hideAuthenticatedControls() {
        // Show login button and public message
        document.getElementById("login-btn").style.display = "inline-block";
        document.getElementById("public-message").style.display = "block";

        // Hide authenticated controls and control panels
        document.getElementById("authenticated-controls").style.display =
          "none";
        document.getElementById("control-panels").style.display = "none";

        // Hide authenticated controls in status cards
        const statusCardControls = document.querySelectorAll(".authenticated-controls");
        statusCardControls.forEach(control => {
          control.style.display = "none";
        });

        console.log("üîí Authenticated controls now hidden");
      }

      // Logout function
      function logout() {
        console.log("üö™ Logging out user...");

        // Clear session storage
        sessionStorage.removeItem("user_data");
        sessionStorage.removeItem("access_token");
        sessionStorage.removeItem("current_user_id");
        sessionStorage.removeItem("current_user_name");
        sessionStorage.removeItem("medications_data");

        // Hide user info and logout button
        const userInfoElement = document.getElementById("user-info");
        const logoutBtn = document.getElementById("logout-btn");

        if (userInfoElement) {
          userInfoElement.style.display = "none";
        }
        if (logoutBtn) {
          logoutBtn.style.display = "none";
        }

        // Hide authenticated controls and show login button
        hideAuthenticatedControls();

        // Reset authentication UI
        resetAuthenticationUI();
        authenticationInProgress = false;

        console.log("‚úÖ Logout successful - returned to home page");
        showNotification("Successfully logged out", "success");
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeTouchScrolling();

        // Always initialize monitoring (sensor data and MQTT status)
        initializeMonitoring();

        // Check for existing authentication
        const isAuthenticated = checkExistingAuthentication();

        // Add event listener for login button as backup
        const loginBtn = document.getElementById("login-btn");
        if (loginBtn) {
          loginBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("üîÑ Login button clicked via event listener");
            showFacialRecognition();
          });
        }

        console.log(
          `üìä Dashboard loaded - Authentication: ${
            isAuthenticated ? "Active" : "None"
          }`
        );
      });

      function goToSchedule() {
        // Get authenticated user data from face recognition
        const userData = sessionStorage.getItem("user_data");
        const accessToken = sessionStorage.getItem("access_token");

        if (!userData || !accessToken) {
          showNotification(
            "Authentication required. Please authenticate first.",
            "warning"
          );
          return;
        }

        try {
          const user = JSON.parse(userData);

          // Construct user name from firstName and lastName
          const userName =
            `${user.firstName || ""} ${user.lastName || ""}`.trim() ||
            user.email ||
            "User";

          // Create a loading modal to show we're accessing the schedule
          const loadingModal = document.createElement("div");
          loadingModal.className = "modal fade";
          loadingModal.id = "scheduleLoadingModal";
          loadingModal.innerHTML = `
                  <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                          <div class="modal-header bg-primary text-white">
                              <h5 class="modal-title">
                                  <i class="fas fa-calendar-alt me-2"></i>Accessing Schedule
                              </h5>
                          </div>
                          <div class="modal-body text-center">
                              <div class="mb-4">
                                  <i class="fas fa-user-check fa-3x text-success mb-3"></i>
                                  <h6 class="text-primary">Welcome, ${userName}!</h6>
                                  <p class="fs-6 text-muted">Loading your medication schedule...</p>
                              </div>
                              <div class="loading-animation">
                                  <div class="spinner-border text-primary me-2" role="status"></div>
                                  <span>Preparing schedule data...</span>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

          document.body.appendChild(loadingModal);
          const modal = new bootstrap.Modal(loadingModal, {
            backdrop: "static",
            keyboard: false,
          });
          modal.show();

          // Store user data for the schedule page
          if (user.id) {
            sessionStorage.setItem("current_user_id", user.id);
          }
          if (user.firstName || user.lastName) {
            sessionStorage.setItem("current_user_name", userName);
          }

          // Fetch user's medication data using the authenticated user's information
          fetchUserMedicationData(user, accessToken)
            .then((medicationData) => {
              if (medicationData) {
                sessionStorage.setItem(
                  "medications_data",
                  JSON.stringify({
                    user_id: user.id,
                    medications: medicationData,
                    timestamp: new Date().toISOString(),
                  })
                );
              }

              // Simulate loading time for better UX
              setTimeout(() => {
                modal.hide();
                loadingModal.addEventListener("hidden.bs.modal", function () {
                  document.body.removeChild(loadingModal);
                  // Redirect to schedule page with user data
                  const redirectUrl = user.id
                    ? `schedule.html?user_id=${user.id}`
                    : "schedule.html";
                  window.location.href = redirectUrl;
                });
              }, 1500);
            })
            .catch((error) => {
              console.error("Error fetching medication data:", error);
              modal.hide();
              loadingModal.addEventListener("hidden.bs.modal", function () {
                document.body.removeChild(loadingModal);
                // Still redirect even if medication data fetch fails
                const redirectUrl = user.id
                  ? `schedule.html?user_id=${user.id}`
                  : "schedule.html";
                window.location.href = redirectUrl;
              });
            });
        } catch (error) {
          console.error("Error parsing user data:", error);
          showNotification(
            "Error accessing user data. Please re-authenticate.",
            "danger"
          );
        }
      }

      async function fetchUserMedicationData(user, accessToken) {
        try {
          const response = await fetch("/api/user-medications", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              user_id: user.id,
              email: user.email,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            return result.medications || [];
          } else {
            console.warn("No medication data available for user");
            return [];
          }
        } catch (error) {
          console.error("Error fetching medication data:", error);
          return [];
        }
      }

      // Initialize the dashboard on page load
      document.addEventListener('DOMContentLoaded', function() {
        console.log("üöÄ Dashboard initializing...");
        
        // Check if user is already authenticated
        checkExistingAuthentication();
        
        // Start monitoring for all users (authenticated and non-authenticated)
        initializeMonitoring();
        
        // Initialize touch scrolling
        initializeTouchScrolling();
        
        console.log("‚úÖ Dashboard initialization complete");
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
