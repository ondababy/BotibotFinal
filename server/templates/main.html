<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotiBot - Dashboard & Face Recognition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Merge of dashboard and face recognition styles --- */
:root {
    /* New Color Scheme with Cream (#FFFDD0) and Midnight Blue (#191970) */
    --primary-color: #FFFDD0;
    --secondary-color: #191970;
    --primary-gradient: linear-gradient(135deg, #FFFDD0 0%, #F5F5DC 50%, #FFF8DC 100%);
    --secondary-gradient: linear-gradient(135deg, #191970 0%, #483D8B 50%, #6A5ACD 100%);
    --success-gradient: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
    --warning-gradient: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    --danger-gradient: linear-gradient(135deg, #FF6347 0%, #DC143C 100%);
    --info-gradient: linear-gradient(135deg, #4682B4 0%, #1E90FF 100%);
    
    /* Enhanced shadows with cream/blue theme */
    --card-shadow: 0 15px 35px rgba(25, 25, 112, 0.1);
    --card-shadow-hover: 0 25px 50px rgba(25, 25, 112, 0.2);
    --border-radius: 20px;
    --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    background: linear-gradient(135deg, #FFFDD0 0%, #F5F5DC 30%, #E6E6FA 70%, #D8BFD8 100%);
    min-height: 100vh;
    overflow-y: auto;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Enhanced Facial Recognition Overlay Styles */
.facial-auth-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #191970 0%, #483D8B 30%, #6A5ACD 70%, #8470FF 100%);
    display: flex; justify-content: center; align-items: center;
    z-index: 9999;
    backdrop-filter: blur(15px);
}

.facial-auth-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 253, 208, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 253, 208, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 253, 208, 0.05) 0%, transparent 50%);
    opacity: 0.6;
}

.facial-auth-container {
    text-align: center; 
    color: #FFFDD0; 
    max-width: 450px; 
    padding: 50px;
    position: relative;
    z-index: 2;
    background: rgba(255, 253, 208, 0.05);
    border-radius: 30px;
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 253, 208, 0.2);
    box-shadow: 0 20px 40px rgba(25, 25, 112, 0.3);
}

.camera-frame {
    width: 280px; 
    height: 280px; 
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.15) 0%, rgba(255, 253, 208, 0.05) 100%);
    border: 6px solid rgba(255, 253, 208, 0.4);
    margin: 0 auto 40px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.4s ease; 
    animation: enhanced-pulse-ring 3s infinite;
    position: relative;
    box-shadow: 
        0 0 30px rgba(255, 253, 208, 0.3),
        inset 0 0 30px rgba(255, 253, 208, 0.1);
}

.camera-frame::before {
    content: '';
    position: absolute;
    top: -10px; left: -10px; right: -10px; bottom: -10px;
    border-radius: 50%;
    background: linear-gradient(45deg, 
        rgba(255, 253, 208, 0.2) 0%, 
        transparent 25%, 
        rgba(255, 253, 208, 0.1) 50%, 
        transparent 75%, 
        rgba(255, 253, 208, 0.2) 100%);
    animation: rotate 4s linear infinite;
    z-index: -1;
}

.camera-feed {
    width: 100%; 
    height: 100%; 
    border-radius: 50%; 
    object-fit: cover; 
    display: none;
    border: 3px solid rgba(255, 253, 208, 0.3);
}

.camera-icon {
    font-size: 80px; 
    color: rgba(255, 253, 208, 0.8); 
    position: absolute; 
    left: 50%; 
    top: 50%; 
    transform: translate(-50%,-50%);
    text-shadow: 0 0 20px rgba(255, 253, 208, 0.4);
    animation: gentle-glow 2s ease-in-out infinite alternate;
}

.auth-title { 
    font-size: 32px; 
    font-weight: 800; 
    margin-bottom: 20px;
    text-shadow: 0 4px 8px rgba(25, 25, 112, 0.3);
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.auth-subtitle { 
    font-size: 18px; 
    margin-bottom: 50px; 
    opacity: 0.95; 
    line-height: 1.6;
    color: rgba(255, 253, 208, 0.9);
    font-weight: 500;
}

.status-message { 
    font-size: 16px; 
    margin: 25px 0; 
    min-height: 25px; 
    font-weight: 600;
    color: rgba(255, 253, 208, 0.9);
    background: rgba(255, 253, 208, 0.1);
    padding: 12px 20px;
    border-radius: 25px;
    backdrop-filter: blur(10px);
}

.verify-btn {
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.2) 0%, rgba(255, 253, 208, 0.1) 100%);
    border: 3px solid rgba(255, 253, 208, 0.6);
    color: #FFFDD0;
    padding: 20px 50px; 
    border-radius: 50px; 
    font-size: 18px; 
    font-weight: 700; 
    cursor: pointer;
    transition: all 0.4s ease; 
    backdrop-filter: blur(15px);
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 8px 25px rgba(255, 253, 208, 0.2);
    position: relative;
    overflow: hidden;
}

.verify-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 253, 208, 0.3), transparent);
    transition: all 0.6s ease;
}

.verify-btn:hover::before {
    left: 100%;
}

.verify-btn:hover { 
    background: linear-gradient(135deg, #FFFDD0 0%, #F5F5DC 100%);
    color: #191970;
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(255, 253, 208, 0.4);
    border-color: #FFFDD0;
}

.verify-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed;
    transform: none;
}

/* Enhanced Animations */
@keyframes enhanced-pulse-ring {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 
            0 0 30px rgba(255, 253, 208, 0.3),
            0 0 0 0 rgba(255, 253, 208, 0.4),
            inset 0 0 30px rgba(255, 253, 208, 0.1);
    }
    50% { 
        transform: scale(1.08); 
        box-shadow: 
            0 0 50px rgba(255, 253, 208, 0.5),
            0 0 0 30px rgba(255, 253, 208, 0),
            inset 0 0 40px rgba(255, 253, 208, 0.2);
    }
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes gentle-glow {
    0% { 
        text-shadow: 0 0 20px rgba(255, 253, 208, 0.4);
        transform: translate(-50%,-50%) scale(1);
    }
    100% { 
        text-shadow: 0 0 30px rgba(255, 253, 208, 0.8);
        transform: translate(-50%,-50%) scale(1.05);
    }
}

.scanning {
    animation: enhanced-pulse-ring 1.5s infinite, rotate 2s linear infinite;
}

@keyframes scanning {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced Dashboard styles */
.dashboard-header { 
    background: var(--secondary-gradient);
    color: #FFFDD0; 
    padding: 60px 0; 
    box-shadow: var(--card-shadow); 
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 253, 208, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 253, 208, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 253, 208, 0.06) 0%, transparent 50%);
    opacity: 0.8;
}

.dashboard-header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(255, 253, 208, 0.6), transparent);
}

.dashboard-header h1, .dashboard-header p {
    position: relative; z-index: 2;
}

.dashboard-header h1 {
    font-weight: 800;
    font-size: 3.5rem;
    text-shadow: 0 4px 8px rgba(25, 25, 112, 0.3);
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.dashboard-header p {
    font-size: 1.3rem;
    color: rgba(255, 253, 208, 0.95);
    font-weight: 500;
}

.dashboard-controls {
    display: flex;
    justify-content: center;
    gap: 25px;
    flex-wrap: wrap;
    position: relative;
    z-index: 2;
    margin-top: 30px;
}

/* Enhanced Status Cards */
.status-card {
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    margin-bottom: 30px;
    border: none;
    overflow: hidden;
    position: relative;
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
    border: 2px solid rgba(25, 25, 112, 0.1);
}

.status-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 6px;
    background: var(--secondary-gradient);
}

.status-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.8) 0%, rgba(255, 253, 208, 0.4) 100%);
    opacity: 0;
    transition: var(--transition);
    pointer-events: none;
}

.status-card:hover {
    transform: translateY(-12px) scale(1.03);
    box-shadow: 0 25px 50px rgba(25, 25, 112, 0.2);
    border-color: rgba(25, 25, 112, 0.2);
}

.status-card:hover::after {
    opacity: 1;
}

.status-card .card-body {
    padding: 35px 25px;
    position: relative;
    z-index: 1;
}

.status-card i {
    margin-bottom: 20px;
    opacity: 0.9;
    filter: drop-shadow(0 4px 8px rgba(25, 25, 112, 0.1));
}

.control-panel {
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
    border-radius: var(--border-radius);
    padding: 35px;
    margin-bottom: 30px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    border: 2px solid rgba(25, 25, 112, 0.1);
}

.control-panel:hover {
    box-shadow: var(--card-shadow-hover);
    border-color: rgba(25, 25, 112, 0.2);
}

.control-panel h5 {
    color: #191970;
    font-weight: 700;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.chart-container {
    position: relative;
    height: 380px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.3) 0%, rgba(255, 253, 208, 0.1) 100%);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(25, 25, 112, 0.1);
}

.servo-control {
    margin: 20px 0;
}

.sensor-value {
    font-size: 2.8rem;
    font-weight: 800;
    margin: 15px 0;
    text-shadow: 0 2px 4px rgba(25, 25, 112, 0.1);
    color: #191970;
}

.sensor-label {
    font-size: 1rem;
    color: #483D8B;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

.timestamp {
    font-size: 0.9rem;
    color: #6A5ACD;
    font-weight: 500;
    margin-top: 10px;
    background: rgba(25, 25, 112, 0.1);
    padding: 6px 12px;
    border-radius: 15px;
    display: inline-block;
}

.card {
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 2px solid rgba(25, 25, 112, 0.1);
    transition: var(--transition);
    overflow: hidden;
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
}

.card:hover {
    box-shadow: var(--card-shadow-hover);
    border-color: rgba(25, 25, 112, 0.2);
    transform: translateY(-5px);
}

.card-header {
    background: linear-gradient(135deg, rgba(25, 25, 112, 0.05) 0%, rgba(25, 25, 112, 0.02) 100%);
    border-bottom: 2px solid rgba(25, 25, 112, 0.1);
    padding: 25px 30px;
    font-weight: 700;
}

.card-header h5 {
    margin: 0;
    color: #191970;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.3rem;
}

.card-body {
    padding: 30px;
}

/* Enhanced Buttons */
.btn {
    border-radius: 18px;
    padding: 16px 35px;
    font-weight: 700;
    transition: var(--transition);
    border: none;
    box-shadow: 0 6px 20px rgba(25, 25, 112, 0.15);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: all 0.6s ease;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(25, 25, 112, 0.25);
}

.btn-primary {
    background: var(--secondary-gradient);
    color: #FFFDD0;
}

.btn-success {
    background: var(--success-gradient);
    color: white;
}

.btn-info {
    background: var(--info-gradient);
    color: white;
}

.form-range {
    height: 10px;
    border-radius: 5px;
}

.form-range::-webkit-slider-thumb {
    background: var(--secondary-gradient);
    border-radius: 50%;
    box-shadow: 0 3px 8px rgba(25, 25, 112, 0.3);
}

.form-control, .form-select {
    border-radius: 15px;
    border: 2px solid rgba(25, 25, 112, 0.2);
    padding: 15px 20px;
    transition: var(--transition);
    background: rgba(255, 253, 208, 0.5);
    color: #191970;
    font-weight: 500;
}

.form-control:focus, .form-select:focus {
    border-color: #191970;
    box-shadow: 0 0 0 4px rgba(25, 25, 112, 0.1);
    background: rgba(255, 253, 208, 0.8);
}

.badge {
    border-radius: 15px;
    padding: 12px 20px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(25, 25, 112, 0.2);
}

.container {
    max-width: 1400px;
}

/* Enhanced Color variants for status cards */
.status-card.temp::before { 
    background: var(--danger-gradient); 
}
.status-card.temp .sensor-value { 
    color: #DC143C; 
}

.status-card.distance::before { 
    background: var(--info-gradient); 
}
.status-card.distance .sensor-value { 
    color: #1E90FF; 
}

.status-card.weight::before { 
    background: var(--warning-gradient); 
}
.status-card.weight .sensor-value { 
    color: #FF8C00; 
}

.status-card.bpm::before { 
    background: var(--success-gradient); 
}
.status-card.bpm .sensor-value { 
    color: #228B22; 
}

/* Enhanced Print modal styles */
.print-summary {
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.8) 0%, rgba(255, 253, 208, 0.6) 100%);
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid rgba(25, 25, 112, 0.1);
    box-shadow: var(--card-shadow);
}

.reading-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 0;
    border-bottom: 1px solid rgba(25, 25, 112, 0.1);
}

.reading-item:last-child {
    border-bottom: none;
}

.reading-label {
    font-weight: 600;
    color: #191970;
    display: flex;
    align-items: center;
    font-size: 1.1rem;
}

.reading-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #483D8B;
    font-family: 'Courier New', monospace;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .dashboard-header h1 { font-size: 2.5rem; }
    .dashboard-header p { font-size: 1.1rem; }
    .sensor-value { font-size: 2.2rem; }
    .dashboard-controls { flex-direction: column; align-items: center; }
    .control-panel, .card-body { padding: 25px; }
    .chart-container { height: 280px; }
    .camera-frame { width: 240px; height: 240px; }
    .facial-auth-container { padding: 40px 30px; }
}

/* Hide scrollbars */
body {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

body::-webkit-scrollbar {
    display: none;
}

/* Touch scrolling */
body {
    touch-action: pan-y;
    -webkit-overflow-scrolling: touch;
    cursor: grab;
}

body.dragging {
    cursor: grabbing;
    user-select: none;
}

/* Enhanced touch targets */
.btn, .form-control, .form-select, .form-range {
    min-height: 48px;
    touch-action: manipulation;
}

/* Touch feedback */
.btn:active, .card:active {
    transform: scale(0.98);
    transition: transform 0.1s ease;
}

/* Animation for loading states */
.loading {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Notification styles */
.alert {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: var(--card-shadow);
}

/* Enhanced PIN Modal Styles */
.pin-input-container {
    max-width: 300px;
    margin: 0 auto;
}

.modal-content {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: 0 30px 60px rgba(25, 25, 112, 0.3);
    background: linear-gradient(135deg, #FFFDD0 0%, #FFF8DC 100%);
    border: 2px solid rgba(25, 25, 112, 0.1);
}

.modal-header {
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
    background: var(--secondary-gradient);
    border: none;
    padding: 25px 35px;
}

.modal-header .modal-title {
    color: #FFFDD0;
    font-weight: 700;
}

.modal-body {
    padding: 40px 35px;
    background: linear-gradient(135deg, rgba(255, 253, 208, 0.8) 0%, rgba(255, 253, 208, 0.6) 100%);
}

.modal-footer {
    padding: 25px 35px;
    border: none;
    background: rgba(25, 25, 112, 0.05);
}

/* Enhanced Error States */
.is-invalid {
    border-color: #DC143C !important;
    box-shadow: 0 0 0 4px rgba(220, 20, 60, 0.25) !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}

/* PIN input styling */
        .pin-input-container {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Modal styling improvements */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
    </style>
</head>
<body>
    <!-- Facial Recognition Overlay -->
    <!-- <div id="facial-auth-overlay" class="facial-auth-overlay" > -->
    <div id="facial-auth-overlay" class="facial-auth-overlay" style="display: none;">
        <div class="facial-auth-container">
            <div class="camera-frame" id="camera-frame">
                <img id="camera-feed" class="camera-feed" alt="Camera Feed" />
                <div class="camera-icon" id="camera-icon">🔒</div>
            </div>
            <h2 class="auth-title">Secure Access Required</h2>
            <p class="auth-subtitle">Please verify your identity to access dashboard</p>
            <div class="status-message" id="auth-status"></div>
            <button class="verify-btn" id="verify-btn" onclick="startFacialRecognition()">
                VERIFY IDENTITY
            </button>
        </div>
    </div>

    <div id="main-dashboard" style="display: block;">
        <div class="dashboard-header">
            <div class="container">
                <h1 class="text-center mb-3">
                    <i class="fas fa-robot me-3"></i>Botibot MQTT Control Dashboard
                </h1>
                <p class="text-center mb-4 fs-5">Real-time sensor monitoring and device control via MQTT</p>
                <div class="text-center mb-3">
                    <span class="badge bg-info fs-6" id="connection-status">
                        🔄 Checking Connection...
                    </span>
                </div>
                <div class="dashboard-controls">
                    <button class="btn btn-info" onclick="printReadings()">
                        <i class="fas fa-print me-2"></i>Print Readings
                    </button>
                    <!-- <button class="btn btn-success" onclick="dispensePill()">
                        <i class="fas fa-pills me-2"></i>Dispense Pill
                    </button> -->
                    <button class="btn btn-success" onclick="goToSchedule()">
                        <i class="fas fa-calendar-alt me-2"></i>Schedule
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sensor Data Cards -->
        <div class="container mt-4">
            <!-- Status Cards Row -->
            <div class="row g-4 mb-5">
                <div class="col-lg-3 col-md-6">
                    <div class="card status-card temp text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <i class="fas fa-thermometer-half fa-3x text-danger mb-3"></i>
                            <div class="sensor-value text-danger" id="temp-value">--</div>
                            <div class="sensor-label">Temperature (°C)</div>
                            <div class="timestamp" id="temp-time">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card status-card distance text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <i class="fas fa-ruler fa-3x text-info mb-3"></i>
                            <div class="sensor-value text-info" id="distance-value">--</div>
                            <div class="sensor-label">Distance (cm)</div>
                            <div class="timestamp" id="distance-time">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card status-card weight text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <i class="fas fa-weight fa-3x text-warning mb-3"></i>
                            <div class="sensor-value text-warning" id="weight-value">--</div>
                            <div class="sensor-label">Weight (kg)</div>
                            <div class="timestamp" id="weight-time">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card status-card bpm text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <i class="fas fa-heartbeat fa-3x text-success mb-3"></i>
                            <div class="sensor-value text-success" id="bpm-value">--</div>
                            <div class="sensor-label">Heart Rate (BPM)</div>
                            <div class="timestamp" id="bpm-time">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alcohol Level Card -->
            <div class="row g-4 mb-5">
                <div class="col-lg-3 col-md-6 mx-auto">
                    <div class="card status-card text-center h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <i class="fas fa-wine-glass-alt fa-3x text-danger mb-3"></i>
                            <div class="sensor-value text-danger" id="alcohol-value">--</div>
                            <div class="sensor-label">Alcohol Level</div>
                            <div class="timestamp" id="alcohol-time">--</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div class="row g-4 mb-5">
                <div class="col-12">
                    <div class="control-panel">
                        <h5><i class="fas fa-pills text-info"></i>Pill Dispenser Control</h5>
                        <p class="text-muted mb-3"><i class="fas fa-info-circle me-2"></i>Uses stepper motor control values</p>
                        <div class="d-grid">
                            <button class="btn btn-info" onclick="dispensePill()">
                                <i class="fas fa-pills me-2"></i>Dispense Pill
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="control-panel">
                        <h5><i class="fas fa-cog text-primary"></i>Servo Motor Control</h5>
                        <div class="servo-control">
                            <label for="servo-slider" class="form-label fw-semibold">
                                Servo Angle: <span class="text-primary fw-bold" id="servo-angle">90</span>°
                            </label>
                            <input type="range" class="form-range mb-3" min="0" max="180" value="90" id="servo-slider">
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="setServo()">
                                    <i class="fas fa-paper-plane me-2"></i>Set Servo Position
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="control-panel">
                        <h5><i class="fas fa-step-forward text-success"></i>Stepper Motor Control</h5>
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label for="stepper-steps" class="form-label fw-semibold">Steps</label>
                                <input type="number" class="form-control" id="stepper-steps" placeholder="Enter steps" value="1000">
                            </div>
                            <div class="col-6">
                                <label for="stepper-direction" class="form-label fw-semibold">Direction</label>
                                <select class="form-select" id="stepper-direction">
                                    <option value="CW">🔄 Clockwise</option>
                                    <option value="CCW">🔄 Counter-clockwise</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="moveStepper()">
                                <i class="fas fa-play me-2"></i>Execute Movement
                            </button>
                        </div>
                    </div>
                </div>
            </div> -->

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line text-primary"></i>Gyroscope Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="gyroChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-area text-success"></i>Accelerometer Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="accelChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-wine text-danger"></i>Alcohol Level Monitor</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="alcoholChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-weight-hanging text-warning"></i>Load Cell Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="loadChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Print Modal -->
        <div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="printModalLabel">
                            <i class="fas fa-print text-primary me-2"></i>Current Sensor Readings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="print-summary" id="printSummary">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Print Now
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendToPrinter()">
                            <i class="fas fa-paper-plane me-2"></i>Send to Printer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        
         function fornow() {
            window.location.href = "schedule.html";
        }
        
        let authenticationInProgress = false;
        function startFacialRecognition() {
            if (authenticationInProgress) return;
            authenticationInProgress = true;
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            
            // UI scanning state
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'SCANNING...';
            cameraIcon.textContent = '📸';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            cameraFrame.classList.add('scanning');
            statusMessage.textContent = '🔄 Analyzing biometric data...';
            statusMessage.style.color = '#FFE066';
            
            cameraFeed.src = '/video_feed';
            cameraFeed.onload = () => { 
                cameraFeed.style.display = 'block'; 
                cameraIcon.style.display = 'none'; 
            };
            cameraFeed.onerror = () => { 
                cameraFeed.style.display = 'none'; 
                cameraIcon.style.display = 'block'; 
                cameraIcon.textContent = '❌'; 
            };
            
            // Start recognition process after 2 seconds
            setTimeout(() => authenticateWithFacialRecognition(), 2000);
        }
        function authenticateWithFacialRecognition() {
            // Capture image from video feed (same method as face_recognition.html)
            captureImageFromVideoFeed()
                .then(imageBase64 => {
                    if (imageBase64) {
                        console.log(`📸 Image captured from video feed, sending to port 3000...`);
                        recognizeFaceOnPort3000(imageBase64);
                    } else {
                        throw new Error('Failed to capture image from video feed');
                    }
                })
                .catch(error => {
                    console.error('Image capture error:', error);
                    authenticationFailed('Camera capture failed: ' + error.message);
                });
        }

        function captureImageFromVideoFeed() {
            return new Promise((resolve, reject) => {
                try {
                    const cameraFeed = document.getElementById('camera-feed');
                    
                    if (!cameraFeed || !cameraFeed.complete || cameraFeed.naturalWidth === 0) {
                        reject(new Error('Camera feed not ready'));
                        return;
                    }
                    
                    // Create canvas to capture current frame from MJPEG stream
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    // Set canvas size to match image
                    canvas.width = cameraFeed.naturalWidth || 640;
                    canvas.height = cameraFeed.naturalHeight || 480;
                    
                    // Validate image dimensions
                    if (canvas.width === 0 || canvas.height === 0) {
                        reject(new Error('Invalid camera feed dimensions'));
                        return;
                    }
                    
                    // Draw current frame from MJPEG feed to canvas
                    context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                    
                    // Convert canvas to base64 image
                    const imageDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    const base64Data = imageDataUrl.split(',')[1];
                    
                    // Validate captured image
                    if (!base64Data || base64Data.length < 100) {
                        reject(new Error('Captured image is empty or invalid'));
                        return;
                    }
                    
                    console.log(`📸 Image captured from video feed (${canvas.width}x${canvas.height})`);
                    resolve(base64Data);
                    
                } catch (error) {
                    console.error('Video feed capture error:', error);
                    reject(error);
                }
            });
        }

        function recognizeFaceOnPort3000(imageBase64) {
            // Test servers in priority order - your actual server runs on port 3000
            const servers = [
                "http://localhost:3000",     // Local server on port 3000
                "http://127.0.0.1:3000",     // Local server on port 3000
            ];
            
            console.log('🔍 Connecting to face recognition server on port 3000...');
            testServersAndRecognize(servers, 0, imageBase64);
        }
        

        function testServersAndRecognize(servers, index, imageBase64) {
            if (index >= servers.length) {
                const errorMessage = 'No face recognition server available. Possible issues:\n' +
                    '• Port 3000 is blocked by browser security (unsafe port)\n' +
                    '• Face recognition server is not running\n' +
                    '• Network connectivity issues\n\n' +
                    'Solutions:\n' +
                    '• Start your face recognition server on port 8080 or 3000\n' +
                    '• Use --disable-web-security flag in Chrome (not recommended)\n' +
                    '• Configure server to use a safe port';
                
                console.error('🚫 All face recognition servers failed:');
                console.error('Port 3000 is typically blocked by browsers as an unsafe port.');
                console.error('Consider running your face recognition server on port 8080 or 3000.');
                
                authenticationFailed(errorMessage);
                return;
            }
            
            const serverUrl = servers[index];
            console.log(`🔍 Testing face recognition server: ${serverUrl}`);
            
            // Special handling for port 3000 warnings
            if (serverUrl.includes(':3000')) {
                console.warn('⚠️ Attempting port 3000 - this may be blocked by browser security');
            }
            
            // Test connection first
            fetch(`${serverUrl}/`, { 
                method: 'GET',
                signal: AbortSignal.timeout(3000)
            })
            .then(response => {
                if (response.status === 200 || response.status === 404) {
                    console.log(`✅ Server ${serverUrl} connected`);
                    tryRecognitionEndpoints(serverUrl, imageBase64);
                } else {
                    console.log(`⚠️ Server ${serverUrl} returned ${response.status}, trying next...`);
                    testServersAndRecognize(servers, index + 1, imageBase64);
                }
            })
            .catch(error => {
                if (error.message.includes('ERR_UNSAFE_PORT') || serverUrl.includes(':3000')) {
                    console.error(`🚫 Port 3000 blocked by browser security: ${serverUrl}`);
                    console.error('💡 Suggestion: Run your face recognition server on port 8080 or 3000');
                } else {
                    console.log(`❌ Server ${serverUrl} failed: ${error.message}`);
                }
                testServersAndRecognize(servers, index + 1, imageBase64);
            });
        }

        function tryRecognitionEndpoints(serverUrl, imageBase64) {
            // Endpoints to try - matching your actual server routes
            const endpoints = [
                "/api/face/recognize",       // Your main face recognition endpoint
                "/api/auth/face-login",      // Auth-based face login
                "/api/face/login",           // Face login endpoint
                "/api/auth/recognize",       // Auth recognize endpoint
                "/api/recognize",            // Generic recognize endpoint
                "/login"                     // Generic login endpoint
            ];
            
            // Updated payload format to match your server expectations
            const payload = { 
                image: imageBase64,
                timestamp: new Date().toISOString(),
                source: 'web_dashboard'
            };
            
            tryEndpoint(serverUrl, endpoints, 0, payload);
        }

        function tryEndpoint(serverUrl, endpoints, index, payload) {
            if (index >= endpoints.length) {
                authenticationFailed('All face recognition endpoints on port 3000 failed');
                return;
            }
            
            const endpoint = endpoints[index];
            const url = `${serverUrl}${endpoint}`;
            
            console.log(`🔄 Trying endpoint: ${endpoint} on ${serverUrl}`);
            
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal: AbortSignal.timeout(10000)
            })
            .then(response => {
                console.log(`📡 Response from ${endpoint}: ${response.status}`);
                
                if (response.status === 200) {
                    return response.json().then(data => {
                        console.log(`✅ Face recognition successful with endpoint: ${endpoint}`);
                        console.log('✅ Response data:', data);
                        
                        // Handle different response formats from your Flask server
                        if (data.success && data.user) {
                            // Flask server format with 'user' field
                            const userResponse = {
                                success: true,
                                recognized_user: data.user,
                                confidence_data: { confidence: data.confidence || 0.95 },
                                access_token: data.token || data.access_token
                            };
                            authenticationSuccessWithUser(userResponse);
                        } else if (data.success && data.recognized_user) {
                            // Direct format from server
                            authenticationSuccessWithUser(data);
                        } else if (data.data && data.data.success && data.data.recognized_user) {
                            // Wrapped format from face_recognition_client.py
                            authenticationSuccessWithUser(data.data);
                        } else if (data.recognized_user) {
                            // Server response without wrapper
                            authenticationSuccessWithUser(data);
                        } else if (data.authenticated) {
                            // Simple authentication response
                            const simpleResponse = {
                                success: true,
                                recognized_user: { 
                                    firstName: 'User', 
                                    lastName: '', 
                                    email: 'authenticated@user.com' 
                                },
                                confidence_data: { confidence: data.confidence || 0.95 }
                            };
                            authenticationSuccessWithUser(simpleResponse);
                        } else {
                            // Check for confidence data even if not recognized
                            const message = data.message || data.error || 'Face not recognized';
                            const confidenceData = data.confidence_data || data.data?.confidence_data;
                            if (confidenceData) {
                                authenticationFailedWithConfidence(message, confidenceData);
                            } else {
                                authenticationFailed(message);
                            }
                        }
                    });
                } else if (response.status === 400) {
                    return response.json().then(errorData => {
                        console.error(`❌ Bad Request (400) from ${endpoint}:`, errorData);
                        console.error('Request payload was:', payload);
                        
                        // If it's a validation error, try the next endpoint
                        const errorMessage = errorData.message || errorData.error || 'Bad request format';
                        console.log(`⚠️ ${endpoint} rejected request: ${errorMessage}, trying next...`);
                        tryEndpoint(serverUrl, endpoints, index + 1, payload);
                    }).catch(parseError => {
                        return response.text().then(errorText => {
                            console.error(`❌ 400 Error from ${endpoint} (couldn't parse JSON):`, errorText);
                            console.error('Request payload was:', payload);
                            tryEndpoint(serverUrl, endpoints, index + 1, payload);
                        });
                    });
                } else if (response.status === 404) {
                    console.log(`⚠️ Endpoint ${endpoint} not found, trying next...`);
                    tryEndpoint(serverUrl, endpoints, index + 1, payload);
                } else {
                    return response.text().then(errorText => {
                        console.error(`❌ Server error ${response.status}: ${errorText}`);
                        tryEndpoint(serverUrl, endpoints, index + 1, payload);
                    });
                }
            })
            .catch(error => {
                console.error(`❌ Error with endpoint ${endpoint}:`, error);
                tryEndpoint(serverUrl, endpoints, index + 1, payload);
            });
        }

        function authenticationSuccessWithUser(data) {
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            
            const user = data.recognized_user;
            const confidence = data.confidence_data?.confidence || 0.95;
            const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'User';
            
            // Update UI for success
            cameraIcon.textContent = '✓';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            
            cameraFrame.classList.remove('scanning');
            cameraFrame.style.borderColor = '#4CAF50';
            cameraFrame.style.background = 'rgba(76, 175, 80, 0.2)';
            statusMessage.textContent = `✓ Welcome ${userName}! (${(confidence * 100).toFixed(1)}% confidence)`;
            statusMessage.style.color = '#4CAF50';
            verifyBtn.textContent = 'ACCESS GRANTED';
            verifyBtn.style.background = '#4CAF50';
            verifyBtn.style.borderColor = '#4CAF50';
            
            console.log(`🎉 User recognized: ${userName} (${user.email})`);
            
            if (data.access_token) {
                console.log('🔐 User automatically logged in!');
                console.log(`🎫 Token: ${data.access_token.substring(0, 20)}...`);
                
                // Store user data for dashboard use
                sessionStorage.setItem('user_data', JSON.stringify(user));
                sessionStorage.setItem('access_token', data.access_token);
            }
            
            setTimeout(() => {
                document.getElementById('facial-auth-overlay').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                initializeDashboard();
            }, 2000);
        }
        function authenticationSuccess(confidence = 0.95) {
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            cameraIcon.textContent = '✓';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            cameraFrame.classList.remove('scanning');
            cameraFrame.style.borderColor = '#4CAF50';
            cameraFrame.style.background = 'rgba(76, 175, 80, 0.2)';
            statusMessage.textContent = `✓ Identity Verified! (${(confidence * 100).toFixed(1)}% confidence)`;
            statusMessage.style.color = '#4CAF50';
            verifyBtn.textContent = 'ACCESS GRANTED';
            verifyBtn.style.background = '#4CAF50';
            verifyBtn.style.borderColor = '#4CAF50';
            setTimeout(() => {
                document.getElementById('facial-auth-overlay').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                initializeDashboard();
            }, 1500);
        }
        function authenticationFailed(reason) {
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            cameraIcon.textContent = '❌';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            cameraFrame.classList.remove('scanning');
            cameraFrame.style.borderColor = '#F44336';
            cameraFrame.style.background = 'rgba(244, 67, 54, 0.2)';
            statusMessage.textContent = `❌ ${reason}`;
            statusMessage.style.color = '#F44336';
            verifyBtn.textContent = 'TRY AGAIN';
            verifyBtn.style.background = 'rgba(255,255,255,0.2)';
            verifyBtn.style.borderColor = 'white';
            verifyBtn.disabled = false;
            authenticationInProgress = false;
            setTimeout(() => resetAuthenticationUI(), 3000);
        }

        function authenticationFailedWithConfidence(reason, confidenceData) {
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            
            cameraIcon.textContent = '❌';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            
            cameraFrame.classList.remove('scanning');
            cameraFrame.style.borderColor = '#F44336';
            cameraFrame.style.background = 'rgba(244, 67, 54, 0.2)';
            
            // Display detailed confidence information
            const confidence = confidenceData.confidence || 0;
            const accuracy = confidenceData.accuracy || 0;
            statusMessage.innerHTML = `❌ ${reason}<br>🎯 Confidence: ${(confidence * 100).toFixed(1)}% | Accuracy: ${(accuracy * 100).toFixed(1)}%<br>💡 Try adjusting position and lighting`;
            statusMessage.style.color = '#F44336';
            
            verifyBtn.textContent = 'TRY AGAIN';
            verifyBtn.style.background = 'rgba(255,255,255,0.2)';
            verifyBtn.style.borderColor = 'white';
            verifyBtn.disabled = false;
            
            authenticationInProgress = false;
            
            // Log detailed information (matching face_recognition_client.py output)
            console.log("❌ Face not recognized");
            console.log(`🎯 Confidence: ${confidence.toFixed(2)}`);
            console.log(`📊 Accuracy: ${accuracy.toFixed(2)}`);
            console.log("💡 Try adjusting your position and lighting");
            
            setTimeout(() => resetAuthenticationUI(), 5000); // Longer timeout for detailed message
        }

        function resetAuthenticationUI() {
            const verifyBtn = document.getElementById('verify-btn');
            const cameraIcon = document.getElementById('camera-icon');
            const cameraFrame = document.getElementById('camera-frame');
            const statusMessage = document.getElementById('auth-status');
            cameraIcon.textContent = '🔒';
            cameraIcon.style.display = 'block';
            const cameraFeed = document.getElementById('camera-feed');
            if (cameraFeed) cameraFeed.style.display = 'none';
            cameraFrame.style.borderColor = 'rgba(255,255,255,0.3)';
            cameraFrame.style.background = 'rgba(255,255,255,0.1)';
            statusMessage.textContent = '';
            verifyBtn.textContent = 'VERIFY IDENTITY';
            verifyBtn.style.background = 'rgba(255,255,255,0.2)';
            verifyBtn.style.borderColor = 'white';
            verifyBtn.disabled = false;
        }
        // --- Dashboard logic ---
        function initializeDashboard() {
            console.log('🚀 Dashboard authenticated and initialized');
            
            // Start polling for sensor data every 2 seconds
            setInterval(fetchSensorData, 2000);
            
            // Check MQTT status every 5 seconds
            setInterval(checkMqttStatus, 5000);
            
            // Initial data load
            fetchSensorData();
            checkMqttStatus();
            
            console.log('✅ Botibot Dashboard fully initialized');
        }

        // Chart.js setup
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            second: 'HH:mm:ss',
                            minute: 'HH:mm',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            },
            animation: {
                duration: 0
            }
        };

        // Initialize charts
        const gyroChart = new Chart(document.getElementById('gyroChart'), {
            type: 'line',
            data: {
                datasets: [
                    { label: 'X', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1 },
                    { label: 'Y', data: [], borderColor: 'rgb(54, 162, 235)', tension: 0.1 },
                    { label: 'Z', data: [], borderColor: 'rgb(255, 205, 86)', tension: 0.1 }
                ]
            },
            options: chartOptions
        });

        const accelChart = new Chart(document.getElementById('accelChart'), {
            type: 'line',
            data: {
                datasets: [
                    { label: 'X', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1 },
                    { label: 'Y', data: [], borderColor: 'rgb(153, 102, 255)', tension: 0.1 },
                    { label: 'Z', data: [], borderColor: 'rgb(255, 159, 64)', tension: 0.1 }
                ]
            },
            options: chartOptions
        });

        const alcoholChart = new Chart(document.getElementById('alcoholChart'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Alcohol Level',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            },
            options: chartOptions
        });

        const loadChart = new Chart(document.getElementById('loadChart'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Load (g)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                }]
            },
            options: chartOptions
        });

        // Servo slider update
        document.getElementById('servo-slider').oninput = function() {
            document.getElementById('servo-angle').textContent = this.value;
        };

        // Data fetching functions
        function fetchSensorData() {
            fetch('/api/sensor-data')
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error fetching sensor data:', error);
                });
        }

        function checkMqttStatus() {
            fetch('/api/mqtt-status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        if (data.connected) {
                            statusElement.innerHTML = `<i class="fas fa-wifi"></i> MQTT Connected: ${data.broker}:${data.port}`;
                            statusElement.className = 'badge bg-success fs-6';
                        } else {
                            statusElement.innerHTML = `<i class="fas fa-wifi"></i> MQTT Disconnected: ${data.broker}:${data.port}`;
                            statusElement.className = 'badge bg-danger fs-6';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking MQTT status:', error);
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Status Unknown';
                        statusElement.className = 'badge bg-warning fs-6';
                    }
                });
        }

        function updateDashboard(sensorData) {
            console.log('Received sensor data:', sensorData);
            
            // Update status cards
            updateStatusCard('temp', sensorData.temp);
            updateStatusCard('distance', sensorData.distance);
            updateStatusCard('weight', sensorData.weight_value);
            updateStatusCard('bpm', sensorData.bpm);
            updateStatusCard('alcohol', sensorData.alcohol);
            
            // Update charts
            updateChart(gyroChart, sensorData.gyro, ['x', 'y', 'z']);
            updateChart(accelChart, sensorData.accel, ['x', 'y', 'z']);
            updateSingleChart(alcoholChart, sensorData.alcohol);
            updateSingleChart(loadChart, sensorData.weight_value);
        }

        function updateStatusCard(elementId, data) {
            if (data && data.value !== undefined) {
                const valueElement = document.getElementById(`${elementId}-value`);
                const timeElement = document.getElementById(`${elementId}-time`);
                
                if (valueElement && timeElement) {
                    valueElement.textContent = data.value.toFixed(2);
                    timeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                }
            }
        }

        function updateChart(chart, data, axes) {
            if (data && data.timestamp) {
                const timestamp = new Date(data.timestamp);
                
                axes.forEach((axis, index) => {
                    if (data[axis] !== undefined) {
                        chart.data.datasets[index].data.push({
                            x: timestamp,
                            y: data[axis]
                        });
                        
                        // Keep only last 50 points
                        if (chart.data.datasets[index].data.length > 50) {
                            chart.data.datasets[index].data.shift();
                        }
                    }
                });
                
                chart.update('none');
            }
        }

        function updateSingleChart(chart, data) {
            if (data && data.value !== undefined && data.timestamp) {
                const timestamp = new Date(data.timestamp);
                
                chart.data.datasets[0].data.push({
                    x: timestamp,
                    y: data.value
                });
                
                // Keep only last 50 points
                if (chart.data.datasets[0].data.length > 50) {
                    chart.data.datasets[0].data.shift();
                }
                
                chart.update('none');
            }
        }

        function updateElement(elementId, value, unit = '') {
            const element = document.getElementById(elementId);
            if (element) {
                if (unit && !elementId.includes('timestamp')) {
                    element.textContent = `${value}${unit}`;
                } else {
                    element.textContent = value;
                }
            }
        }

        // Control functions
        function setServo() {
            const angle = document.getElementById('servo-slider').value;
            fetch('/api/control/servo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ angle: parseInt(angle) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Servo command sent successfully!', 'success');
                } else {
                    showNotification('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error, 'danger');
            });
        }

        function moveStepper() {
            const steps = document.getElementById('stepper-steps').value;
            const direction = document.getElementById('stepper-direction').value;
            
            fetch('/api/control/stepper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    steps: parseInt(steps), 
                    direction: direction 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Stepper command sent successfully!', 'success');
                } else {
                    showNotification('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error, 'danger');
            });
        }

        function printReadings() {
            const printData = {
                temperature: document.getElementById('temp-value')?.textContent || 'N/A',
                distance: document.getElementById('distance-value')?.textContent || 'N/A',
                weight: document.getElementById('weight-value')?.textContent || 'N/A',
                bpm: document.getElementById('bpm-value')?.textContent || 'N/A',
                alcohol: document.getElementById('alcohol-value')?.textContent || 'N/A',
                timestamp: new Date().toISOString()
            };

            fetch('/print-readings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(printData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(result.message || 'Print command sent successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Printing failed');
                }
            })
            .catch(error => {
                console.error('Error printing:', error);
                showNotification('Error printing: ' + error.message, 'danger');
            });
        }

        function dispensePill() {
            const steps = document.getElementById('stepper-steps').value;
            const direction = document.getElementById('stepper-direction').value;
            
            fetch('/api/control/stepper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    steps: parseInt(steps), 
                    direction: direction 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Pill dispensed successfully!', 'success');
                } else {
                    showNotification('Error dispensing pill: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error, 'danger');
            });
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Touch/Drag Scrolling Implementation
        function initializeTouchScrolling() {
            let isScrolling = false;
            let startY = 0;
            let startX = 0;
            let scrollTop = 0;
            let scrollLeft = 0;
            let isMouseDown = false;
            
            const body = document.body;
            const html = document.documentElement;

            // Mouse Events
            body.addEventListener('mousedown', function(e) {
                if (e.target.matches('button, input, select, textarea, a, .btn, .form-control, .form-select, .form-range')) {
                    return;
                }
                
                isMouseDown = true;
                isScrolling = true;
                startY = e.clientY;
                startX = e.clientX;
                scrollTop = window.pageYOffset || html.scrollTop;
                scrollLeft = window.pageXOffset || html.scrollLeft;
                
                body.classList.add('dragging');
                e.preventDefault();
            });

            body.addEventListener('mousemove', function(e) {
                if (!isScrolling || !isMouseDown) return;
                
                e.preventDefault();
                
                const deltaY = startY - e.clientY;
                const deltaX = startX - e.clientX;
                
                window.scrollTo(scrollLeft + deltaX * 0.8, scrollTop + deltaY * 0.8);
            });

            body.addEventListener('mouseup', function(e) {
                isMouseDown = false;
                isScrolling = false;
                body.classList.remove('dragging');
            });

            body.addEventListener('mouseleave', function(e) {
                isMouseDown = false;
                isScrolling = false;
                body.classList.remove('dragging');
            });

            // Touch Events
            body.addEventListener('touchstart', function(e) {
                if (e.target.matches('button, input, select, textarea, a, .btn, .form-control, .form-select, .form-range')) {
                    return;
                }
                
                if (e.touches.length === 1) {
                    isScrolling = true;
                    const touch = e.touches[0];
                    startY = touch.clientY;
                    startX = touch.clientX;
                    scrollTop = window.pageYOffset || html.scrollTop;
                    scrollLeft = window.pageXOffset || html.scrollLeft;
                    
                    body.classList.add('dragging');
                }
            }, { passive: true });

            body.addEventListener('touchmove', function(e) {
                if (!isScrolling || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const deltaY = startY - touch.clientY;
                const deltaX = startX - touch.clientX;
                
                window.scrollTo(scrollLeft + deltaX * 0.8, scrollTop + deltaY * 0.8);
                e.preventDefault();
            }, { passive: false });

            body.addEventListener('touchend', function(e) {
                isScrolling = false;
                body.classList.remove('dragging');
            }, { passive: true });

            console.log('🖱️ Touch scrolling initialized');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Bypass facial recognition for development
            document.getElementById('facial-auth-overlay').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            initializeDashboard();
            initializeTouchScrolling();
        });
        
        function goToSchedule() {
            // Create a modal for PIN input
            const pinModal = document.createElement('div');
            pinModal.className = 'modal fade';
            pinModal.id = 'pinModal';
            pinModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-lock me-2"></i>Access Schedule
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                                <p class="fs-6 text-muted">Enter your 6-digit PIN to access the schedule</p>
                            </div>
                            <div class="pin-input-container">
                                <input type="password" 
                                       class="form-control form-control-lg text-center" 
                                       id="pinInput" 
                                       placeholder="Enter 6-digit PIN"
                                       maxlength="6"
                                       pattern="[0-9]{6}"
                                       style="font-size: 1.5rem; letter-spacing: 0.5rem; font-family: monospace;">
                            </div>
                            <div id="pinError" class="text-danger mt-2" style="display: none;"></div>
                            <div id="pinLoading" class="mt-3" style="display: none;">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Verifying PIN...
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="verifyPinBtn" onclick="verifyPin()">
                                <i class="fas fa-check me-2"></i>Verify PIN
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(pinModal);
            const modal = new bootstrap.Modal(pinModal);
            modal.show();
            
            // Focus on PIN input when modal opens
            pinModal.addEventListener('shown.bs.modal', function() {
                document.getElementById('pinInput').focus();
            });
            
            // Allow Enter key to submit
            document.getElementById('pinInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPin();
                }
            });
            
            // Auto-format PIN input (only numbers)
            document.getElementById('pinInput').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            
            // Clean up modal when hidden
            pinModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(pinModal);
            });
        }
        
        async function verifyPin() {
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            const pinLoading = document.getElementById('pinLoading');
            const verifyBtn = document.getElementById('verifyPinBtn');
            const pin = pinInput.value.trim();
            
            // Validate PIN format
            if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                showPinError('Please enter a valid 6-digit PIN');
                return;
            }
            
            // Show loading state
            pinLoading.style.display = 'block';
            pinError.style.display = 'none';
            verifyBtn.disabled = true;
            pinInput.disabled = true;
            
            try {
                // Send PIN to backend for verification
                const response = await fetch('/api/verify-pin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pin: pin })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // PIN is correct, show success and redirect
                    pinLoading.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>PIN Verified! Redirecting...';
                    
                    // Store user data for the schedule page
                    if (result.user_id) {
                        sessionStorage.setItem('current_user_id', result.user_id);
                    }
                    if (result.user_name) {
                        sessionStorage.setItem('current_user_name', result.user_name);
                    }
                    if (result.medications) {
                        sessionStorage.setItem('medications_data', JSON.stringify({
                            user_id: result.user_id,
                            medications: result.medications,
                            timestamp: new Date().toISOString()
                        }));
                    }
                    
                    setTimeout(() => {
                        // Redirect with user_id parameter if available
                        const redirectUrl = result.user_id 
                            ? `schedule.html?user_id=${result.user_id}` 
                            : 'schedule.html';
                        window.location.href = redirectUrl;
                    }, 1500);
                    
                } else {
                    // PIN is incorrect
                    showPinError(result.message || 'Invalid PIN. Please try again.');
                    resetPinForm();
                }
                
            } catch (error) {
                console.error('PIN verification error:', error);
                showPinError('Connection error. Please try again.');
                resetPinForm();
            }
        }
        
        function showPinError(message) {
            const pinError = document.getElementById('pinError');
            pinError.textContent = message;
            pinError.style.display = 'block';
            
            // Shake animation for error feedback
            const pinInput = document.getElementById('pinInput');
            pinInput.classList.add('is-invalid');
            pinInput.style.animation = 'shake 0.5s';
            setTimeout(() => {
                pinInput.style.animation = '';
            }, 500);
        }
        
        function resetPinForm() {
            const pinInput = document.getElementById('pinInput');
            const pinLoading = document.getElementById('pinLoading');
            const verifyBtn = document.getElementById('verifyPinBtn');
            
            pinLoading.style.display = 'none';
            verifyBtn.disabled = false;
            pinInput.disabled = false;
            pinInput.classList.remove('is-invalid');
            pinInput.select(); // Select all text for easy re-entry
        }
    </script>
</body>
</html>
